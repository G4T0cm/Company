<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Reagan Bros ¬∑ Bolsa</title>
<link rel="icon" type="image/png" href="https://i.imgur.com/utsUeNP.png">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#070b0f;--panel:#0d1117;--border:#1e3a5f;
  --green:#00ff99;--orange:#ff9933;--red:#ff3355;--blue:#00aaff;
  --text:#e8f4ff;--muted:#4a6a8a;
  --glow-green:0 0 20px #00ff9933;
}
html{font-size:16px;}
body{font-family:'Share Tech Mono',monospace;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::after{content:"";position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);pointer-events:none;z-index:9999;}
body::before{content:"";position:fixed;inset:0;background-image:linear-gradient(rgba(0,170,255,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,170,255,.04) 1px,transparent 1px);background-size:50px 50px;z-index:0;}
.wrap{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:16px;}

header{text-align:center;padding:24px 0 16px;}
.logo{font-family:'Orbitron',sans-serif;font-size:clamp(2rem,6vw,2.8rem);font-weight:900;letter-spacing:clamp(1px,1vw,4px);background:linear-gradient(135deg,var(--blue),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.tagline{font-size:clamp(.85rem,2vw,.9rem);color:var(--muted);text-transform:uppercase;letter-spacing:clamp(1px,1vw,4px);margin-top:6px;}

.header-controls{position:fixed;top:20px;right:20px;z-index:100;}
.header-controls-left{position:fixed;top:20px;left:20px;z-index:100;}
.btn-captura, .btn-cartera{padding:8px 14px;border-radius:6px;border:1.5px solid var(--green);background:transparent;color:var(--green);font-family:'Orbitron',sans-serif;font-weight:600;font-size:clamp(.75rem,1.5vw,.8rem);text-transform:uppercase;letter-spacing:.5px;cursor:pointer;transition:.3s;white-space:nowrap;}
.btn-cartera{border-color:var(--blue);color:var(--blue);}
.btn-captura:hover{background:var(--green);color:#000;box-shadow:0 0 20px #00ff9966;}
.btn-cartera:hover{background:var(--blue);color:#000;box-shadow:0 0 20px #00aaff66;}
.btn-captura:active, .btn-cartera:active{transform:scale(.95);}
.btn-captura.loading, .btn-cartera.loading{opacity:.6;cursor:not-allowed;}
.btn-captura.loading::after, .btn-cartera.loading::after{content:" ‚ü≥";animation:spin .8s linear infinite;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}

.status-bar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:16px;font-size:clamp(.9rem,2.5vw,.95rem);}
.status-left{display:flex;align-items:center;gap:12px;}
.dot{width:10px;height:10px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite;flex-shrink:0;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.live-label{color:var(--green);font-weight:700;letter-spacing:2px;}
#clockDisplay{color:var(--muted);}
.status-right{color:var(--muted);font-size:clamp(.85rem,2vw,.9rem);}
#lastUpdate{color:var(--text);}

.ticker-wrap{overflow:hidden;background:#0a1520;border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:12px 0;margin-bottom:16px;position:relative;}
.ticker-wrap::before,.ticker-wrap::after{content:"";position:absolute;top:0;width:40px;height:100%;z-index:2;}
.ticker-wrap::before{left:0;background:linear-gradient(90deg,#0a1520,transparent);}
.ticker-wrap::after{right:0;background:linear-gradient(-90deg,#0a1520,transparent);}
.ticker{display:flex;white-space:nowrap;animation:scroll 25s linear infinite;}
.ticker:hover{animation-play-state:paused;}
@keyframes scroll{from{transform:translateX(0);}to{transform:translateX(-50%)}}
.ticker-item{display:inline-flex;align-items:center;gap:8px;padding:0 16px;font-size:clamp(1rem,2.5vw,1rem);}
.ticker-name{color:var(--blue);font-weight:700;}
.ticker-price{color:var(--text);}
.ticker-sep{color:var(--muted);}

.stats-row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:18px;}
@media(min-width:600px){.stats-row{grid-template-columns:repeat(4,1fr);}}
.stat{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:16px 8px;text-align:center;position:relative;overflow:hidden;}
.stat::before{content:"";position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--blue),transparent);}
.stat-val{font-family:'Orbitron',sans-serif;font-size:clamp(1.5rem,4vw,1.8rem);font-weight:900;color:var(--green);}
.stat-key{font-size:clamp(.78rem,1.5vw,.82rem);color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-top:6px;}

.section-title{font-family:'Orbitron',sans-serif;font-size:clamp(.9rem,2.5vw,1rem);color:var(--blue);text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;display:flex;align-items:center;gap:10px;}
.section-title::after{content:"";flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent);}

.grid{display:grid;grid-template-columns:1fr;gap:14px;}
@media(min-width:600px){.grid{grid-template-columns:repeat(auto-fill,minmax(300px,1fr));}}

.neg-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:clamp(16px,4vw,20px);position:relative;overflow:hidden;transition:.3s;cursor:default;animation:fadeIn .4s ease both;}
.neg-card::before{content:"";position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--blue),var(--green));}
.neg-card:hover{border-color:#00ff9944;box-shadow:var(--glow-green);transform:translateY(-2px);}

.card-top{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.card-img{width:clamp(52px,10vw,60px);height:clamp(52px,10vw,60px);object-fit:cover;border-radius:8px;border:2px solid var(--border);flex-shrink:0;}
.card-img-ph{width:clamp(52px,10vw,60px);height:clamp(52px,10vw,60px);border-radius:8px;border:2px solid var(--border);background:#0a1520;display:flex;align-items:center;justify-content:center;font-size:clamp(1.6rem,4vw,1.8rem);flex-shrink:0;}
.card-name{font-family:'Orbitron',sans-serif;font-size:clamp(1rem,3vw,1.1rem);color:var(--text);line-height:1.3;}
.card-id{font-size:clamp(.78rem,2vw,.82rem);color:var(--muted);margin-top:4px;}
.card-badge{margin-left:auto;padding:6px 11px;border-radius:20px;font-size:clamp(.78rem,1.8vw,.82rem);font-weight:700;white-space:nowrap;flex-shrink:0;}
.badge-high{background:#00ff9915;color:var(--green);border:1px solid #00ff9940;}
.badge-mid{background:#ff993315;color:var(--orange);border:1px solid #ff993340;}
.badge-low{background:#ff335515;color:var(--red);border:1px solid #ff335540;}

.price-display{display:flex;align-items:flex-end;gap:8px;margin-bottom:14px;}
.price-big{font-family:'Orbitron',sans-serif;font-size:clamp(2.4rem,7vw,2.6rem);font-weight:900;color:var(--green);}
.price-unit{font-size:clamp(.88rem,2vw,.95rem);color:var(--muted);margin-bottom:10px;}

.stock-info{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;}
.s-item{background:#070b0f;border-radius:6px;padding:12px;}
.s-key{font-size:clamp(.76rem,1.8vw,.8rem);color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.s-val{font-size:clamp(1.05rem,2.5vw,1.1rem);color:var(--text);margin-top:4px;}

.progress-label{display:flex;justify-content:space-between;font-size:clamp(.8rem,2vw,.85rem);color:var(--muted);margin-bottom:6px;}
.progress-track{height:8px;background:#0a1520;border-radius:3px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1);}
.fill-green{background:linear-gradient(90deg,#00cc77,var(--green));}
.fill-orange{background:linear-gradient(90deg,#cc7700,var(--orange));}
.fill-red{background:linear-gradient(90deg,#cc1133,var(--red));}

.mcap{display:flex;justify-content:space-between;align-items:center;margin-top:14px;padding-top:12px;border-top:1px solid var(--border);font-size:clamp(.88rem,2vw,.92rem);}
.mcap-label{color:var(--muted);}
.mcap-val{color:var(--blue);font-weight:700;}

.card-chart{margin-top:14px;padding-top:12px;border-top:1px solid var(--border);}
.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.chart-label{font-size:clamp(.76rem,1.8vw,.8rem);color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.chart-delta{font-size:clamp(.88rem,2vw,.92rem);font-weight:700;}
.chart-delta.up{color:var(--green);}
.chart-delta.down{color:var(--red);}
.chart-delta.flat{color:var(--muted);}

.chart-btn-group{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;}
.chart-btn{padding:6px 12px;border-radius:4px;border:1px solid var(--border);background:#0a1520;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:clamp(.7rem,1.5vw,.75rem);cursor:pointer;transition:.2s;white-space:nowrap;}
.chart-btn:hover{border-color:var(--green);color:var(--green);}
.chart-btn-active{background:var(--blue);border-color:var(--blue);color:#000;font-weight:700;}

.chart-wrap{position:relative;height:90px;}

.empty-state{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-state .icon{font-size:3.5rem;display:block;margin-bottom:12px;opacity:.4;}
.empty-state p{font-size:clamp(1rem,2.5vw,1.1rem);letter-spacing:1px;}

#anunciosSection{margin-bottom:24px;}
.anuncio-card{border-radius:10px;padding:clamp(14px,3vw,16px) clamp(16px,4vw,20px);margin-bottom:10px;position:relative;overflow:hidden;animation:fadeIn .4s ease both;}
.anuncio-card::before{content:"";position:absolute;left:0;top:0;bottom:0;width:4px;}
.anuncio-info{background:#00aaff0d;border:1px solid #00aaff33;}.anuncio-info::before{background:var(--blue);}
.anuncio-alerta{background:#ff993308;border:1px solid #ff993344;}.anuncio-alerta::before{background:var(--orange);}
.anuncio-urgente{background:#ff335510;border:1px solid #ff335555;animation:urgentPulse 2s infinite;}.anuncio-urgente::before{background:var(--red);}
.anuncio-oferta{background:#00ff9908;border:1px solid #00ff9933;}.anuncio-oferta::before{background:var(--green);}
@keyframes urgentPulse{0%,100%{border-color:#ff335555;}50%{border-color:#ff3355cc;box-shadow:0 0 12px #ff335533;}}
.anuncio-head{display:flex;align-items:flex-start;gap:10px;margin-bottom:8px;flex-wrap:wrap;}
.anuncio-icon{font-size:clamp(1.1rem,3vw,1.2rem);flex-shrink:0;}
.anuncio-titulo{font-family:'Orbitron',sans-serif;font-size:clamp(.92rem,2.5vw,1rem);color:var(--text);flex:1;}
.anuncio-fecha{font-size:clamp(.78rem,1.8vw,.82rem);color:var(--muted);white-space:nowrap;}
.anuncio-texto{font-size:clamp(.9rem,2.5vw,.95rem);color:#a0b8cc;line-height:1.7;padding-left:2px;}

/* Estilos para la captura */
.captura-container{position:fixed;left:-9999px;top:0;width:1200px;background:#0a0a0a;color:var(--text);font-family:'Share Tech Mono',monospace;z-index:-1;}
.captura-header{background:linear-gradient(135deg,#0066ff,#ff0044);padding:40px 20px;text-align:center;color:#fff;}
.captura-logo{font-family:'Orbitron',sans-serif;font-size:48px;font-weight:900;letter-spacing:4px;}
.captura-tagline{font-size:16px;margin-top:10px;opacity:.95;font-weight:700;}
.captura-time{font-size:20px;margin-top:15px;font-weight:700;font-family:'Orbitron',sans-serif;}
.captura-content{padding:50px 40px;}
.captura-title{font-family:'Orbitron',sans-serif;font-size:32px;color:#0066ff;text-transform:uppercase;letter-spacing:3px;margin-bottom:40px;border-bottom:3px solid #ff0044;padding-bottom:20px;}
.captura-items{display:grid;grid-template-columns:1fr 1fr;gap:25px;}
.captura-item{display:flex;flex-direction:column;align-items:center;gap:15px;padding:25px;background:#111;border:2px solid #0066ff33;border-radius:12px;text-align:center;position:relative;overflow:hidden;}
.captura-item::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#0066ff,#ff0044);}
.captura-item-img{width:120px;height:120px;object-fit:cover;border-radius:8px;border:2px solid #0066ff;flex-shrink:0;}
.captura-item-img-placeholder{width:120px;height:120px;border-radius:8px;border:2px solid #0066ff;background:#1a1a1a;display:flex;align-items:center;justify-content:center;font-size:48px;flex-shrink:0;}
.captura-item-info{flex:1;width:100%;}
.captura-item-name{font-family:'Orbitron',sans-serif;font-size:20px;color:#0066ff;font-weight:900;letter-spacing:1px;}
.captura-item-code{font-size:14px;color:#888;margin-top:6px;font-weight:700;}
.captura-item-price{font-size:40px;font-weight:900;color:#0066ff;font-family:'Orbitron',sans-serif;margin-top:10px;letter-spacing:2px;}
.captura-item-change{display:flex;align-items:center;justify-content:center;gap:10px;font-family:'Orbitron',sans-serif;font-size:22px;font-weight:900;margin-top:12px;letter-spacing:1px;}
.captura-item-change.up{color:#0066ff;}
.captura-item-change.down{color:#ff0044;}
.captura-footer{text-align:center;color:#666;font-size:14px;margin-top:40px;padding-top:20px;border-top:2px solid #333;font-weight:700;letter-spacing:1px;}

footer{text-align:center;padding:24px 0;color:var(--muted);font-size:clamp(.8rem,2vw,.85rem);border-top:1px solid var(--border);margin-top:32px;}

/* Modal de Cartera */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;backdrop-filter:blur(4px);}
.modal-overlay.active{display:flex;align-items:center;justify-content:center;}
.modal-box{background:var(--panel);border:2px solid var(--blue);border-radius:12px;padding:30px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;animation:slideIn .3s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
.modal-close{position:absolute;top:15px;right:15px;background:none;border:none;color:var(--blue);font-size:24px;cursor:pointer;transition:.2s;}
.modal-close:hover{color:var(--green);}
.modal-title{font-family:'Orbitron',sans-serif;font-size:20px;color:var(--blue);text-transform:uppercase;letter-spacing:1px;margin-bottom:20px;}
.form-group{margin-bottom:15px;}
.form-label{display:block;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.form-input{width:100%;padding:10px 12px;background:#070b0f;border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:14px;transition:.2s;}
.form-input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 8px #00aaff22;}
.btn-submit{width:100%;padding:10px;background:var(--blue);border:none;border-radius:6px;color:#000;font-family:'Orbitron',sans-serif;font-weight:700;cursor:pointer;transition:.2s;margin-top:10px;}
.btn-submit:hover{background:#00ccff;box-shadow:0 0 15px #00aaff44;}
.btn-submit.loading{opacity:.6;cursor:not-allowed;}

.cartera-info{display:none;}
.cartera-info.active{display:block;}
.cartera-user-header{background:linear-gradient(135deg,var(--blue),var(--green));color:#000;padding:20px;border-radius:8px;margin-bottom:20px;text-align:center;}
.cartera-user-name{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;letter-spacing:1px;}
.cartera-user-id{font-size:12px;opacity:.8;margin-top:4px;}
.cartera-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.cartera-stat{background:#070b0f;border:1px solid var(--border);border-radius:6px;padding:12px;text-align:center;}
.cartera-stat-val{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;color:var(--green);}
.cartera-stat-key{font-size:11px;color:var(--muted);margin-top:4px;}
.cartera-acciones-title{font-family:'Orbitron',sans-serif;font-size:14px;color:var(--blue);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:8px;}
.cartera-accion{background:#070b0f;border:1px solid var(--border);border-radius:6px;padding:12px;margin-bottom:10px;}
.cartera-accion-name{font-family:'Orbitron',sans-serif;color:var(--text);font-weight:700;font-size:13px;}
.cartera-accion-code{font-size:11px;color:var(--muted);margin-top:2px;}
.cartera-accion-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;font-size:12px;}
.cartera-accion-stat{display:flex;justify-content:space-between;}
.cartera-accion-stat-key{color:var(--muted);}
.cartera-accion-stat-val{color:var(--green);font-weight:700;}
.error-msg{color:var(--red);background:#ff335510;border:1px solid #ff335533;padding:12px;border-radius:6px;margin-bottom:15px;font-size:12px;}
.loading-spinner{text-align:center;color:var(--muted);}
.loading-spinner::after{content:"‚ü≥";display:inline-block;animation:spin .8s linear infinite;font-size:20px;}

@keyframes fadeIn{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
@keyframes flash{0%{background:#00ff9910;}100%{background:var(--panel);}}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
@keyframes slideUp{from{opacity:1;transform:translateX(-50%) translateY(0);}to{opacity:0;transform:translateX(-50%) translateY(-20px);}}
.neg-card.updated{animation:flash .8s ease;}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">REAGAN BROS Co.</div>
    <div class="tagline">PRECIOS DE ACCIONES ¬∑ En vivo</div>
  </header>

  <div class="header-controls-left">
    <button class="btn-cartera" onclick="abrirModalCartera()">üë§ Cartera</button>
  </div>

  <div class="header-controls">
    <button class="btn-captura" onclick="generarCaptura()">üì∏ Captura</button>
  </div>

  <div class="status-bar">
    <div class="status-left">
      <div class="dot"></div>
      <span class="live-label">EN VIVO</span>
      <span id="clockDisplay">--:--:--</span>
    </div>
    <div class="status-right">√ölt. actualizaci√≥n: <span id="lastUpdate">‚Äî</span></div>
  </div>

  <div class="ticker-wrap">
    <div class="ticker" id="ticker">
      <span class="ticker-item"><span class="ticker-name">CARGANDO</span><span class="ticker-sep">¬∑</span><span class="ticker-price">‚Äî</span></span>
      <span class="ticker-item"><span class="ticker-name">CARGANDO</span><span class="ticker-sep">¬∑</span><span class="ticker-price">‚Äî</span></span>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat"><div class="stat-val" id="statTotal">‚Äî</div><div class="stat-key">Negocios</div></div>
    <div class="stat"><div class="stat-val" id="statAccDisp">‚Äî</div><div class="stat-key">Acc. disponibles</div></div>
    <div class="stat"><div class="stat-val" id="statAccVend">‚Äî</div><div class="stat-key">En circulaci√≥n</div></div>
    <div class="stat"><div class="stat-val" id="statCapMercado">‚Äî</div><div class="stat-key">Cap. mercado</div></div>
  </div>

  <div id="anunciosSection" style="display:none;">
    <div class="section-title">üì¢ Tabl√≥n de anuncios</div>
    <div id="listaAnuncios"></div>
  </div>

  <div class="section-title">Empresas cotizadas</div>
  <div class="grid" id="gridNegocios"></div>

  <footer>REAGAN BROS COMPANY ¬∑ BOLSA DE VALORES ¬∑ DATOS EN TIEMPO REAL</footer>
</div>

<!-- Contenedor para la captura (oculto) -->
<div class="captura-container" id="capturaContainer"></div>

<!-- Modal de Cartera -->
<div class="modal-overlay" id="modalCartera">
  <div class="modal-box">
    <button class="modal-close" onclick="cerrarModalCartera()">‚úï</button>
    
    <div class="modal-title">üìä Mi Cartera</div>
    
    <!-- Formulario de b√∫squeda -->
    <div id="formularioCartera">
      <div class="form-group">
        <label class="form-label">ID de Usuario (Gestor√≠a)</label>
        <input type="text" id="usuarioId" class="form-input" placeholder="Ej: usuario123" onkeypress="if(event.key==='Enter') consultarCartera()">
      </div>
      <button class="btn-submit" onclick="consultarCartera()">Consultar Cartera</button>
      <div id="errorMsg"></div>
    </div>
    
    <!-- Informaci√≥n de la cartera -->
    <div id="infoCartera" class="cartera-info">
      <div class="cartera-user-header">
        <div class="cartera-user-name" id="nombreUsuario">‚Äî</div>
        <div class="cartera-user-id" id="idUsuario">‚Äî</div>
      </div>
      
      <div class="cartera-stats">
        <div class="cartera-stat">
          <div class="cartera-stat-val" id="totalAcciones">0</div>
          <div class="cartera-stat-key">Total Acciones</div>
        </div>
        <div class="cartera-stat">
          <div class="cartera-stat-val" id="valorTotal">‚Äî</div>
          <div class="cartera-stat-key">Valor Total</div>
        </div>
      </div>
      
      <div class="cartera-acciones-title">üìà Tus Acciones</div>
      <div id="listaAcciones"></div>
      
      <button class="btn-submit" style="background:var(--orange);margin-top:20px;" onclick="cerrarModalCartera()">Cerrar</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyAVJ5PrfRQpjPfgVXvlXGTrlaNLckaRY6U",
  authDomain:"reaganbroscompany.firebaseapp.com",
  databaseURL:"https://reaganbroscompany-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId:"reaganbroscompany",
  storageBucket:"reaganbroscompany.firebasestorage.app",
  messagingSenderId:"792852543624",
  appId:"1:792852543624:web:62e71a8704cb346f22873d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let prevData = {};
const cardCharts = {};
const chartFilters = {};
let currentNegociosData = {};

setInterval(() => {
  document.getElementById("clockDisplay").textContent = new Date().toLocaleTimeString('es-ES');
}, 1000);

function fmtMoney(n) {
  if (!n && n !== 0) return '‚Äî';
  if (n >= 1e9) return `$${(n/1e9).toFixed(2)}B`;
  if (n >= 1e6) return `$${(n/1e6).toFixed(2)}M`;
  if (n >= 1e3) return `$${(n/1e3).toFixed(2)}K`;
  return `$${Number(n).toLocaleString('es-ES')}`;
}
function fmtNum(n) { return Number(n).toLocaleString('es-ES'); }
function stockPct(disp, total) { if (!total) return 0; return Math.round((disp / total) * 100); }
function badgeClass(pct) { return pct > 60 ? 'badge-high' : pct > 25 ? 'badge-mid' : 'badge-low'; }
function badgeLabel(pct) { return pct > 60 ? 'üü¢ ALTA' : pct > 25 ? 'üü° MEDIA' : 'üî¥ ESCASA'; }
function fillClass(pct) { return pct > 60 ? 'fill-green' : pct > 25 ? 'fill-orange' : 'fill-red'; }

function showPopup(msg) {
  const popup = document.createElement('div');
  popup.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#ff9933,#00ff99);color:#000;padding:16px 28px;border-radius:8px;font-weight:700;font-family:Orbitron,sans-serif;z-index:10000;box-shadow:0 0 20px #00ff9944;animation:slideDown .3s ease;';
  popup.textContent = msg;
  document.body.appendChild(popup);
  setTimeout(() => {
    popup.style.animation = 'slideUp .3s ease';
    setTimeout(() => popup.remove(), 300);
  }, 2500);
}

function updateTicker(data) {
  const items = Object.entries(data);
  if (!items.length) return;
  const half = items.map(([k, n]) =>
    `<span class="ticker-item">
      <span class="ticker-name">${n.nombre.toUpperCase()}</span>
      <span class="ticker-sep">¬∑</span>
      <span class="ticker-price">${fmtMoney(n.valorAccion)}</span>
      <span class="ticker-sep">¬∑</span>
      <span style="color:var(--muted)">${n.acciones} acc.</span>
    </span>`
  ).join('<span class="ticker-item" style="color:var(--border);">‚óÜ</span>');
  document.getElementById("ticker").innerHTML = half + half;
}

function updateStats(data) {
  const list = Object.values(data);
  const totalDisp = list.reduce((s, n) => s + (n.acciones || 0), 0);
  const totalAcc = list.reduce((s, n) => s + (n.accionesTotales || n.acciones || 0), 0);
  const cap = list.reduce((s, n) => s + ((n.accionesTotales || n.acciones || 0) * (n.valorAccion || 0)), 0);
  document.getElementById("statTotal").textContent = list.length;
  document.getElementById("statAccDisp").textContent = fmtNum(totalDisp);
  document.getElementById("statAccVend").textContent = fmtNum(totalAcc - totalDisp);
  document.getElementById("statCapMercado").textContent = fmtMoney(cap);
}

function filterPuntos(puntos, tipo) {
  if (!puntos || puntos.length === 0) return [];
  const ahora = new Date();
  let limite = 0;
  
  if (tipo === 'day') {
    // Medianoche de hoy (00:00:00)
    const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
    limite = hoy.getTime();
  } else if (tipo === 'week') {
    // Hace 7 d√≠as desde hoy
    const hace7dias = new Date(ahora);
    hace7dias.setDate(hace7dias.getDate() - 7);
    limite = hace7dias.getTime();
  } else if (tipo === 'month') {
    // Hace 30 d√≠as desde hoy
    const hace30dias = new Date(ahora);
    hace30dias.setDate(hace30dias.getDate() - 30);
    limite = hace30dias.getTime();
  }
  
  return puntos.filter(p => p.ts >= limite);
}

window.updateChartFilter = function(k, tipo) {
  chartFilters[k] = tipo;
  const buttons = document.querySelectorAll(`button[data-chart="${k}"]`);
  buttons.forEach(btn => btn.classList.remove('chart-btn-active'));
  document.querySelector(`button[data-chart="${k}"][data-tipo="${tipo}"]`).classList.add('chart-btn-active');
  
  const n = window.negociosDataGlobal[k];
  if (n && n.valorHistorial) {
    updateChartSection(k, n.valorHistorial);
  }
};

function buildOrUpdateChart(k, puntos) {
  const canvas = document.getElementById('chart-' + k);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const labels = puntos.map(p => {
    const d = new Date(p.ts);
    return d.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'}) + ' ' + d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
  });
  const valores = puntos.map(p => p.precio);
  const color = valores[valores.length-1] >= valores[0] ? '#00ff99' : '#ff3344';
  if (cardCharts[k]) {
    cardCharts[k].data.labels = labels;
    cardCharts[k].data.datasets[0].data = valores;
    cardCharts[k].data.datasets[0].borderColor = color;
    cardCharts[k].data.datasets[0].backgroundColor = color + '18';
    cardCharts[k].update('none');
    return;
  }
  cardCharts[k] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ data: valores, borderColor: color, backgroundColor: color+'18', fill: true, tension: 0.3, pointRadius: 2, pointBackgroundColor: color, borderWidth: 1.5 }] },
    options: {
      responsive: true, maintainAspectRatio: false, animation: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: false }, tooltip: { backgroundColor: '#0d1117', borderColor: color, borderWidth: 1, titleColor: '#4a6a8a', bodyColor: '#e8f4ff', callbacks: { label: c => `  $${c.parsed.y.toLocaleString('es-ES')}` } } },
      scales: { x: { display: false }, y: { display: false, grace: '10%' } }
    }
  });
}

function updateChartSection(k, historial) {
  const allPuntos = Object.values(historial || {}).map(v => (typeof v === 'object' && v.ts) ? v : null).filter(Boolean).sort((a, b) => a.ts - b.ts);
  const tipo = chartFilters[k] || 'day';
  const puntos = filterPuntos(allPuntos, tipo);
  
  const deltaEl = document.getElementById('delta-' + k);
  if (puntos.length < 2) { 
    if (deltaEl) { deltaEl.textContent = '‚Äî'; deltaEl.className = 'chart-delta flat'; } 
    return; 
  }
  const diff = puntos[puntos.length-1].precio - puntos[0].precio;
  const pct = ((diff / puntos[0].precio) * 100).toFixed(2);
  const sign = diff >= 0 ? '+' : '';
  if (deltaEl) { 
    deltaEl.textContent = `${sign}${fmtMoney(diff)} (${sign}${pct}%)`; 
    deltaEl.className = 'chart-delta ' + (diff > 0 ? 'up' : diff < 0 ? 'down' : 'flat'); 
  }
  buildOrUpdateChart(k, puntos);
}

function renderCards(data) {
  const grid = document.getElementById("gridNegocios");
  const keys = Object.keys(data);
  if (!keys.length) {
    grid.innerHTML = '<div class="empty-state"><span class="icon">üè¶</span><p>No hay empresas cotizando a√∫n</p></div>';
    return;
  }
  grid.querySelectorAll('.neg-card').forEach(card => {
    const id = card.id.replace('card-', '');
    if (!data[id]) { if (cardCharts[id]) { cardCharts[id].destroy(); delete cardCharts[id]; } card.remove(); }
  });
  keys.forEach((k, i) => {
    const n = data[k];
    const total = n.accionesTotales || n.acciones || 0;
    const disp = n.acciones || 0;
    const vendidas = total - disp;
    const pct = stockPct(disp, total);
    const cap = total * (n.valorAccion || 0);
    const changed = prevData[k] && (prevData[k].valorAccion !== n.valorAccion || prevData[k].acciones !== n.acciones);
    const existing = document.getElementById('card-' + k);
    if (existing) {
      const priceEl = existing.querySelector('.price-big'); if (priceEl) priceEl.textContent = fmtMoney(n.valorAccion);
      const badgeEl = existing.querySelector('.card-badge'); if (badgeEl) { badgeEl.textContent = badgeLabel(pct); badgeEl.className = 'card-badge ' + badgeClass(pct); }
      const sVals = existing.querySelectorAll('.s-val');
      if (sVals[0]) sVals[0].textContent = fmtNum(disp);
      if (sVals[1]) sVals[1].textContent = fmtNum(vendidas);
      if (sVals[2]) sVals[2].textContent = fmtNum(total);
      if (sVals[3]) sVals[3].textContent = fmtMoney(cap);
      const fill = existing.querySelector('.progress-fill'); if (fill) { fill.style.width = pct + '%'; fill.className = 'progress-fill ' + fillClass(pct); }
      const progLabels = existing.querySelectorAll('.progress-label span'); if (progLabels[1]) progLabels[1].textContent = pct + '%';
      const mcapVal = existing.querySelector('.mcap-val'); if (mcapVal) mcapVal.textContent = fmtMoney(vendidas * (n.valorAccion || 0));
      if (changed) { existing.classList.remove('updated'); void existing.offsetWidth; existing.classList.add('updated'); setTimeout(() => existing.classList.remove('updated'), 900); }
    } else {
      const imgTag = n.imagen ? `<img class="card-img" src="${n.imagen}" onerror="this.style.display='none';this.nextSibling.style.display='flex'">` : '';
      const phTag = `<div class="card-img-ph" ${n.imagen ? 'style="display:none"' : ''}>üè¢</div>`;
      grid.insertAdjacentHTML('beforeend', `
        <div class="neg-card" style="animation-delay:${i*0.06}s" id="card-${k}">
          <div class="card-top">${imgTag}${phTag}
            <div>
              <div class="card-name">${n.nombre}</div>
              <div class="card-id">${k.toUpperCase()}${n.categoria?' ¬∑ '+n.categoria.toUpperCase():''}</div>
            </div>
            <span class="card-badge ${badgeClass(pct)}">${badgeLabel(pct)}</span>
          </div>
          <div class="price-display">
            <div class="price-big">${fmtMoney(n.valorAccion)}</div>
            <div class="price-unit">/ acci√≥n</div>
          </div>
          <div class="stock-info">
            <div class="s-item"><div class="s-key">Disponibles</div><div class="s-val">${fmtNum(disp)}</div></div>
            <div class="s-item"><div class="s-key">En circulaci√≥n</div><div class="s-val">${fmtNum(vendidas)}</div></div>
            <div class="s-item"><div class="s-key">Total emitidas</div><div class="s-val">${fmtNum(total)}</div></div>
            <div class="s-item"><div class="s-key">Cap. mercado</div><div class="s-val">${fmtMoney(cap)}</div></div>
          </div>
          <div class="progress-label"><span>Disponibilidad</span><span>${pct}%</span></div>
          <div class="progress-track"><div class="progress-fill ${fillClass(pct)}" style="width:${pct}%"></div></div>
          <div class="mcap">
            <span class="mcap-label">Valor total emitido</span>
            <span class="mcap-val">${fmtMoney(vendidas*(n.valorAccion||0))}</span>
          </div>
          <div class="card-chart">
            <div class="chart-header">
              <span class="chart-label">üìà Historial de precio</span>
              <span class="chart-delta flat" id="delta-${k}">‚Äî</span>
            </div>
            <div class="chart-btn-group">
              <button class="chart-btn chart-btn-active" data-chart="${k}" data-tipo="day" onclick="updateChartFilter('${k}', 'day')">üìÖ D√≠a</button>
              <button class="chart-btn" data-chart="${k}" data-tipo="week" onclick="updateChartFilter('${k}', 'week')">üìä Semana</button>
              <button class="chart-btn" data-chart="${k}" data-tipo="month" onclick="updateChartFilter('${k}', 'month')">üìà Mes</button>
            </div>
            <div class="chart-wrap" id="chartwrap-${k}"><canvas id="chart-${k}"></canvas></div>
          </div>
        </div>`);
    }
    updateChartSection(k, n.valorHistorial);
  });
}

window.negociosDataGlobal = {};

onValue(ref(db, 'negocios/'), snapshot => {
  const raw = snapshot.val() || {};
  const data = Object.fromEntries(Object.entries(raw).filter(([k, n]) => n.estado !== 'liquidacion'));
  window.negociosDataGlobal = data;
  currentNegociosData = data;
  renderCards(data);
  updateTicker(data);
  updateStats(data);
  document.getElementById("lastUpdate").textContent = new Date().toLocaleTimeString('es-ES');
  prevData = JSON.parse(JSON.stringify(data));
});

const TIPOS = { info:'‚ÑπÔ∏è', alerta:'‚ö†Ô∏è', urgente:'üö®', oferta:'üí∞' };
onValue(ref(db, 'anuncios/'), snapshot => {
  const data = snapshot.val() || {};
  const section = document.getElementById("anunciosSection");
  const cont = document.getElementById("listaAnuncios");
  const anuncios = Object.values(data).sort((a, b) => b.fecha - a.fecha);
  if (!anuncios.length) { section.style.display = 'none'; return; }
  section.style.display = 'block';
  cont.innerHTML = anuncios.map(a => `
    <div class="anuncio-card anuncio-${a.tipo||'info'}">
      <div class="anuncio-head">
        <span class="anuncio-icon">${TIPOS[a.tipo]||'üìå'}</span>
        <span class="anuncio-titulo">${a.titulo}</span>
        <span class="anuncio-fecha">${new Date(a.fecha).toLocaleString('es-ES')}</span>
      </div>
      <div class="anuncio-texto">${a.texto}</div>
    </div>`).join('');
});

// Funci√≥n para generar la captura
window.generarCaptura = async function() {
  const btn = document.querySelector('.btn-captura');
  btn.classList.add('loading');
  btn.disabled = true;
  
  try {
    const data = currentNegociosData;
    const container = document.getElementById('capturaContainer');
    const ahora = new Date();
    const fechaHora = ahora.toLocaleString('es-ES');
    
    // Construir el HTML de la captura
    let items = '';
    Object.entries(data).slice(0, 8).forEach(([k, n]) => {
      const total = n.accionesTotales || n.acciones || 0;
      const disp = n.acciones || 0;
      const vendidas = total - disp;
      const precioActual = n.valorAccion || 0;
      
      // Obtener el precio anterior (del historial)
      const historial = n.valorHistorial ? Object.values(n.valorHistorial).map(v => (typeof v === 'object' && v.precio) ? v : null).filter(Boolean).sort((a, b) => a.ts - b.ts) : [];
      const precioPrevio = historial.length > 0 ? historial[historial.length - 2]?.precio || historial[0]?.precio : precioActual;
      const cambio = precioActual - precioPrevio;
      const pctCambio = precioPrevio ? ((cambio / precioPrevio) * 100).toFixed(2) : 0;
      
      const isUp = cambio >= 0;
      const changeSymbol = isUp ? '‚ñ≤' : '‚ñº';
      
      // Imagen o placeholder
      const imgHTML = n.imagen 
        ? `<img class="captura-item-img" src="${n.imagen}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
        : '';
      const placeholderHTML = `<div class="captura-item-img-placeholder" ${n.imagen ? 'style="display:none"' : ''}>üè¢</div>`;
      
      items += `
        <div class="captura-item">
          ${imgHTML}${placeholderHTML}
          <div class="captura-item-info">
            <div class="captura-item-name">${n.nombre}</div>
            <div class="captura-item-code">${k.toUpperCase()}</div>
            <div class="captura-item-price">${precioActual.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}$</div>
            <div class="captura-item-change ${isUp ? 'up' : 'down'}">
              ${changeSymbol} ${Math.abs(cambio).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}$ (${isUp ? '+' : ''}${pctCambio}%)
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = `
      <div style="background:#0a0a0a;min-height:100%;">
        <div class="captura-header">
          <div class="captura-logo">REAGAN BROS</div>
          <div class="captura-tagline">BOLSA DE VALORES</div>
          <div class="captura-time">${fechaHora}</div>
        </div>
        <div class="captura-content">
          <div class="captura-title">üìä Cotizaciones en vivo</div>
          <div class="captura-items">
            ${items}
          </div>
          <div class="captura-footer">
            Reagan Bros Company ‚Ä¢ Bolsa de Valores ‚Ä¢ Datos en tiempo real
          </div>
        </div>
      </div>
    `;
    
    // Usar html2canvas para capturar la imagen
    const canvas = await html2canvas(container, {
      backgroundColor: '#0a0a0a',
      scale: 2,
      useCORS: true,
      allowTaint: true
    });
    
    // Descargar la imagen
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = `bolsa-reagan-${ahora.getFullYear()}-${String(ahora.getMonth()+1).padStart(2,'0')}-${String(ahora.getDate()).padStart(2,'0')}-${String(ahora.getHours()).padStart(2,'0')}${String(ahora.getMinutes()).padStart(2,'0')}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Limpiar
    container.innerHTML = '';
    showPopup('üì∏ Captura descargada!');
  } catch (error) {
    console.error('Error generando captura:', error);
    showPopup('‚ùå Error al generar la captura');
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
};

// Funciones para la cartera
window.abrirModalCartera = function() {
  document.getElementById('modalCartera').classList.add('active');
  document.getElementById('usuarioId').focus();
};

window.cerrarModalCartera = function() {
  document.getElementById('modalCartera').classList.remove('active');
  document.getElementById('formularioCartera').style.display = 'block';
  document.getElementById('infoCartera').classList.remove('active');
  document.getElementById('usuarioId').value = '';
  document.getElementById('errorMsg').innerHTML = '';
};

window.consultarCartera = async function() {
  const idJuego = document.getElementById('usuarioId').value.trim();
  const errorDiv = document.getElementById('errorMsg');
  const btn = document.querySelector('.btn-submit');
  
  if (!idJuego) {
    errorDiv.innerHTML = '<div class="error-msg">Por favor ingresa tu ID de usuario</div>';
    return;
  }
  
  btn.classList.add('loading');
  btn.disabled = true;
  errorDiv.innerHTML = '';
  
  try {
    // Obtener los clientes de Firebase
    const clientesSnapshot = await new Promise((resolve, reject) => {
      onValue(ref(db, 'clientes/'), (snapshot) => {
        resolve(snapshot);
      }, (error) => {
        reject(error);
      }, { onlyOnce: true });
    });
    
    const clientesData = clientesSnapshot.val() || {};
    
    // Buscar el cliente con el idJuego coincidente
    let clienteId = null;
    let cliente = null;
    
    for (const [key, data] of Object.entries(clientesData)) {
      if (data.idJuego === idJuego) {
        clienteId = key;
        cliente = data;
        break;
      }
    }
    
    if (!cliente) {
      errorDiv.innerHTML = '<div class="error-msg">‚ùå Usuario no encontrado con ese ID</div>';
      btn.classList.remove('loading');
      btn.disabled = false;
      return;
    }
    
    // Obtener acciones del cliente
    const acciones = cliente.acciones || {};
    
    // Calcular totales usando negociosDataGlobal
    let totalAcciones = 0;
    let valorTotal = 0;
    const accionesList = [];
    
    Object.entries(acciones).forEach(([negocioId, cantidad]) => {
      if (typeof cantidad === 'number' && cantidad > 0) {
        const negocioData = window.negociosDataGlobal[negocioId];
        if (negocioData) {
          totalAcciones += cantidad;
          const valorAccion = negocioData.valorAccion || 0;
          const valorSubtotal = cantidad * valorAccion;
          valorTotal += valorSubtotal;
          
          accionesList.push({
            id: negocioId,
            nombre: negocioData.nombre,
            cantidad: cantidad,
            precio: valorAccion,
            subtotal: valorSubtotal
          });
        }
      }
    });
    
    // Ordenar por cantidad descendente
    accionesList.sort((a, b) => b.cantidad - a.cantidad);
    
    // Mostrar informaci√≥n
    document.getElementById('nombreUsuario').textContent = cliente.nombre || 'Usuario';
    document.getElementById('idUsuario').textContent = `ü™™ ${idJuego}`;
    document.getElementById('totalAcciones').textContent = totalAcciones;
    document.getElementById('valorTotal').textContent = fmtMoney(valorTotal);
    
    // Mostrar acciones
    const listaAcciones = document.getElementById('listaAcciones');
    if (accionesList.length === 0) {
      listaAcciones.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">üì≠ No tienes acciones en tu cartera</div>';
    } else {
      listaAcciones.innerHTML = accionesList.map((acc, idx) => `
        <div class="cartera-accion" style="animation:fadeIn .3s ease both;animation-delay:${idx*0.05}s">
          <div class="cartera-accion-name">üè¢ ${acc.nombre}</div>
          <div class="cartera-accion-code">${acc.id.toUpperCase()}</div>
          <div class="cartera-accion-stats">
            <div class="cartera-accion-stat">
              <span class="cartera-accion-stat-key">Cantidad:</span>
              <span class="cartera-accion-stat-val">${acc.cantidad} acc.</span>
            </div>
            <div class="cartera-accion-stat">
              <span class="cartera-accion-stat-key">Precio/u:</span>
              <span class="cartera-accion-stat-val">${fmtMoney(acc.precio)}</span>
            </div>
            <div class="cartera-accion-stat">
              <span class="cartera-accion-stat-key">Subtotal:</span>
              <span class="cartera-accion-stat-val">${fmtMoney(acc.subtotal)}</span>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // Mostrar cartera y ocultar formulario
    document.getElementById('formularioCartera').style.display = 'none';
    document.getElementById('infoCartera').classList.add('active');
    
  } catch (error) {
    console.error('Error consultando cartera:', error);
    errorDiv.innerHTML = '<div class="error-msg">‚ùå Error al consultar la cartera. Intenta de nuevo.</div>';
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
};
</script>
</body>
</html>

