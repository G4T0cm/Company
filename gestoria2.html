<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reagan Bros Co</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#0a0a0a;--panel:#111;--panel2:#161616;
  --border:#00ff9933;--green:#00ff99;--orange:#ff9933;
  --red:#ff3344;--blue:#00aaff;--purple:#bb88ff;
  --text:#f0f0f0;--muted:#888;--glow:0 0 12px #00ff9944;
}
body{font-family:'Share Tech Mono',monospace;background:var(--bg);color:var(--text);min-height:100vh;}
body::before{content:"";position:fixed;inset:0;
  background:url("https://static0.gamerantimages.com/wordpress/wp-content/uploads/2023/07/best-businesses-to-buy-in-gta-online.jpg") center/cover;
  opacity:.08;z-index:-1;}
#loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.96);display:flex;align-items:center;justify-content:center;z-index:1000;}
#loginBox{background:var(--panel2);padding:40px;border-radius:12px;border:2px solid var(--green);box-shadow:0 0 30px #00ff9933;text-align:center;width:340px;}
#loginBox h2{font-family:'Orbitron',sans-serif;font-size:1.4rem;color:var(--green);margin-bottom:20px;}
#loginBox input{width:100%;padding:12px;margin-bottom:12px;border-radius:6px;border:1px solid var(--border);background:#0a0a0a;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.95rem;}
#loginBox input:focus{outline:none;border-color:var(--orange);}
#loginBox button{width:100%;padding:13px;background:linear-gradient(135deg,var(--orange),var(--green));border:none;border-radius:6px;color:#000;font-family:'Orbitron',sans-serif;font-weight:700;font-size:1rem;cursor:pointer;}
#loginError{color:var(--red);margin-top:10px;font-size:.85rem;}
.app{display:none;max-width:1200px;margin:0 auto;padding:20px;}
header{text-align:center;padding:20px 0 30px;}
header h1{font-family:'Orbitron',sans-serif;font-size:2.2rem;font-weight:900;background:linear-gradient(135deg,var(--orange),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
header p{color:var(--green);font-size:.9rem;text-transform:uppercase;margin-top:5px;letter-spacing:2px;}
.tabs{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.tab{flex:1;min-width:90px;padding:10px 4px;text-align:center;background:var(--panel2);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:.2s;color:var(--text);font-size:.78rem;white-space:nowrap;}
.tab:hover{border-color:var(--green);color:var(--green);}
.tab.active{background:var(--green);color:#000;border-color:var(--green);font-weight:700;}
.panel{display:none;background:var(--panel);border:2px solid var(--border);border-radius:12px;padding:24px;box-shadow:var(--glow);}
.panel.active{display:block;}
.panel h2{font-family:'Orbitron',sans-serif;font-size:1.1rem;color:var(--green);margin-bottom:18px;border-bottom:1px solid var(--border);padding-bottom:10px;}
.panel h3{font-family:'Orbitron',sans-serif;font-size:.9rem;color:var(--orange);margin:16px 0 10px;}
input,select,textarea{width:100%;padding:11px 14px;margin-top:8px;border-radius:6px;border:1px solid var(--border);background:#0a0a0a;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.9rem;}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--orange);box-shadow:0 0 8px #ff993344;}
textarea{resize:vertical;min-height:80px;}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
label{display:block;margin-top:14px;font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.btn{padding:9px 16px;border:none;border-radius:5px;font-family:'Share Tech Mono',monospace;font-size:.85rem;font-weight:700;cursor:pointer;transition:.2s;}
.btn:hover{opacity:.8;}
.btn-green{background:var(--green);color:#000;}
.btn-orange{background:var(--orange);color:#000;}
.btn-red{background:var(--red);color:#fff;}
.btn-blue{background:var(--blue);color:#000;}
.btn-ghost{background:transparent;border:1px solid var(--green);color:var(--green);}
.btn-ghost-red{background:transparent;border:1px solid var(--red);color:var(--red);}
.btn-sm{padding:5px 10px;font-size:.75rem;}
.btn-group{display:flex;gap:6px;margin-top:14px;flex-wrap:wrap;align-items:center;}
.card{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-top:10px;transition:.2s;}
.card:hover{border-color:#00ff9966;}
.card-header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.card-img{width:56px;height:56px;object-fit:cover;border-radius:6px;border:2px solid var(--green);flex-shrink:0;}
.card-img-placeholder{width:56px;height:56px;border-radius:6px;border:2px solid var(--border);background:#1a1a1a;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;}
.card-title{font-family:'Orbitron',sans-serif;font-size:.95rem;color:var(--green);}
.card-sub{font-size:.8rem;color:var(--muted);margin-top:3px;}
.card-actions{margin-left:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
.card-body{margin-top:12px;display:none;}
.card.expanded .card-body{display:block;}
.card-inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
.badge{display:inline-block;padding:3px 9px;border-radius:12px;font-size:.73rem;font-weight:700;}
.badge-green{background:#00ff9922;color:var(--green);border:1px solid #00ff9944;}
.badge-orange{background:#ff993322;color:var(--orange);border:1px solid #ff993344;}
.badge-red{background:#ff334422;color:var(--red);border:1px solid #ff334444;}
.badge-blue{background:#00aaff22;color:var(--blue);border:1px solid #00aaff44;}
.status-activa{background:#00ff9922;color:var(--green);border:1px solid #00ff9944;padding:3px 9px;border-radius:12px;font-size:.73rem;font-weight:700;}
.status-suspendida{background:#ff993322;color:var(--orange);border:1px solid #ff993344;padding:3px 9px;border-radius:12px;font-size:.73rem;font-weight:700;}
.status-liquidacion{background:#ff334422;color:var(--red);border:1px solid #ff334444;padding:3px 9px;border-radius:12px;font-size:.73rem;font-weight:700;}
.stock-bar{margin-top:8px;}
.stock-bar-label{display:flex;justify-content:space-between;font-size:.78rem;color:var(--muted);margin-bottom:4px;}
.stock-track{height:8px;background:#1a1a1a;border-radius:4px;overflow:hidden;}
.stock-fill{height:100%;border-radius:4px;transition:width .5s;background:linear-gradient(90deg,var(--orange),var(--green));}
.result-section{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-top:12px;}
.result-section h3{font-family:'Orbitron',sans-serif;font-size:.9rem;color:var(--orange);margin-bottom:12px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
.info-item{background:#0a0a0a;border-radius:6px;padding:10px;}
.info-item .key{font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.info-item .val{font-size:1rem;color:var(--text);margin-top:3px;}
.holdings-list{margin-top:8px;}
.holding-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid var(--border);font-size:.85rem;}
.holding-row:last-child{border-bottom:none;}
.trans-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.82rem;}
.trans-table th{padding:8px 10px;text-align:left;color:var(--muted);border-bottom:1px solid var(--border);font-weight:400;text-transform:uppercase;font-size:.73rem;letter-spacing:1px;}
.trans-table td{padding:8px 10px;border-bottom:1px solid #ffffff08;}
.trans-table tr:hover td{background:#ffffff05;}
.rank-row{display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px solid var(--border);transition:.2s;}
.rank-row:hover{background:#ffffff05;}
.rank-num{font-family:'Orbitron',sans-serif;font-size:1.2rem;color:var(--muted);width:30px;flex-shrink:0;}
.rank-num.gold{color:#ffd700;}.rank-num.silver{color:#c0c0c0;}.rank-num.bronze{color:#cd7f32;}
.rank-info{flex:1;}.rank-name{font-size:.9rem;color:var(--text);}
.rank-detail{font-size:.75rem;color:var(--muted);margin-top:2px;}
.rank-val{font-family:'Orbitron',sans-serif;font-size:1rem;color:var(--green);}
.log-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
.log-filters select,.log-filters input{width:auto;flex:1;min-width:130px;margin-top:0;}
.log-entry{display:flex;gap:10px;align-items:flex-start;padding:8px 0;border-bottom:1px solid #ffffff08;font-size:.82rem;}
.log-time{color:var(--muted);white-space:nowrap;flex-shrink:0;}
.log-type{flex-shrink:0;}.log-msg{color:var(--text);}
#logsContainer{max-height:500px;overflow-y:auto;}
#logsPaginacion{display:flex;gap:8px;margin-top:12px;justify-content:center;align-items:center;}
#popup{position:fixed;top:20px;right:20px;padding:14px 20px;border-radius:8px;background:linear-gradient(135deg,var(--orange),var(--green));color:#000;font-weight:700;display:none;z-index:9999;box-shadow:0 0 20px #00ff9944;max-width:300px;}
#modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:5000;display:none;align-items:center;justify-content:center;}
#modalOverlay.open{display:flex;}
#modalBox{background:var(--panel2);border:2px solid var(--orange);border-radius:12px;padding:28px;width:90%;max-width:540px;box-shadow:0 0 30px #ff993333;position:relative;max-height:85vh;overflow-y:auto;}
#modalBox h2{font-family:'Orbitron',sans-serif;color:var(--orange);margin-bottom:16px;}
#modalClose{position:absolute;top:14px;right:16px;background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer;}
#modalClose:hover{color:var(--red);}
.trash-card{background:#1a0a0a;border:1px solid #ff334433;border-radius:8px;padding:12px;margin-top:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
.trash-name{color:var(--red);font-size:.85rem;}
.trash-meta{font-size:.75rem;color:var(--muted);margin-top:2px;}
.anuncio-card{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-top:10px;}
.anuncio-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}
.anuncio-titulo{font-family:'Orbitron',sans-serif;font-size:.9rem;color:var(--orange);}
.anuncio-fecha{font-size:.72rem;color:var(--muted);}
.anuncio-texto{font-size:.85rem;color:var(--text);margin-top:8px;line-height:1.6;}
.nota-display{background:#0a0a0a;border-radius:6px;padding:10px;font-size:.82rem;color:var(--text);line-height:1.6;margin-top:8px;border-left:3px solid var(--orange);white-space:pre-wrap;}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px;}
.stat-card{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:14px;text-align:center;}
.stat-card .val{font-family:'Orbitron',sans-serif;font-size:1.6rem;color:var(--green);}
.stat-card .key{font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px;}
.divider{border:none;border-top:1px solid var(--border);margin:16px 0;}
.chart-container{position:relative;height:220px;margin-top:12px;}
.cat-pill{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.7rem;background:#00aaff22;color:var(--blue);border:1px solid #00aaff33;margin-left:6px;}
.limit-warn{background:#ff993315;border:1px solid var(--orange);border-radius:6px;padding:8px 12px;font-size:.8rem;color:var(--orange);margin-top:8px;display:none;}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:#111;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--green);}
.empty{text-align:center;padding:30px;color:var(--muted);font-size:.9rem;}
.empty span{font-size:2rem;display:block;margin-bottom:8px;}
@media(max-width:700px){
  header h1{font-size:1.5rem;}
  .field-row{grid-template-columns:1fr;}
  .info-grid{grid-template-columns:1fr;}
  .card-inputs{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div id="loginOverlay">
  <div id="loginBox">
    <h2>ğŸ” ACCESO</h2>
    <input type="text" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPass" placeholder="ContraseÃ±a">
    <button onclick="login()">ENTRAR</button>
    <p id="loginError"></p>
  </div>
</div>

<div id="modalOverlay">
  <div id="modalBox">
    <button id="modalClose" onclick="cerrarModal()">âœ•</button>
    <div id="modalContent"></div>
  </div>
</div>

<div class="app" id="appContainer">
  <header>
    <h1>ğŸ“Š Reagan Bros Co.</h1>
    <p>GestiÃ³n De Acciones</p>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="dashboard">ğŸ“ˆ Dashboard</div>
    <div class="tab" data-tab="negocios">ğŸ¢ Negocios</div>
    <div class="tab" data-tab="clientes">ğŸ‘¥ Clientes</div>
    <div class="tab" data-tab="transacciones">ğŸ’± Trans.</div>
    <div class="tab" data-tab="buscar">ğŸ” Buscar</div>
    <div class="tab" data-tab="ranking">ğŸ† Ranking</div>
    <div class="tab" data-tab="anuncios">ğŸ“¢ Anuncios</div>
    <div class="tab" data-tab="papelera">ğŸ—‘ï¸ Papelera</div>
    <div class="tab" data-tab="logs">ğŸ“‹ Logs</div>
  </div>

  <!-- DASHBOARD -->
  <div class="panel active" id="dashboard">
    <h2>ğŸ“ˆ Resumen General</h2>
    <div class="stats-row">
      <div class="stat-card"><div class="val" id="statNegocios">â€”</div><div class="key">Negocios</div></div>
      <div class="stat-card"><div class="val" id="statClientes">â€”</div><div class="key">Clientes</div></div>
      <div class="stat-card"><div class="val" id="statTransacciones">â€”</div><div class="key">Transacciones</div></div>
      <div class="stat-card"><div class="val" id="statVolumen">â€”</div><div class="key">Volumen Total</div></div>
      <div class="stat-card"><div class="val" id="statAnuncios">â€”</div><div class="key">Anuncios</div></div>
      <div class="stat-card"><div class="val" id="statPapelera">â€”</div><div class="key">En papelera</div></div>
    </div>
    <h2>ğŸ¢ Vista rÃ¡pida</h2>
    <div id="dashboardNegocios"></div>
  </div>

  <!-- NEGOCIOS -->
  <div class="panel" id="negocios">
    <h2>ğŸ¢ Agregar Negocio</h2>
    <div class="field-row">
      <div><label>ID del negocio</label><input id="idNegocio" placeholder="ej: maze-bank"></div>
      <div><label>Nombre</label><input id="nombreNegocio" placeholder="ej: Maze Bank"></div>
    </div>
    <div class="field-row">
      <div><label>Acciones totales</label><input id="accionesNegocio" type="number" placeholder="1000" min="1"></div>
      <div><label>Valor por acciÃ³n ($)</label><input id="valorAccion" type="number" placeholder="500" min="1"></div>
    </div>
    <div class="field-row">
      <div><label>CategorÃ­a</label>
        <select id="categoriaNegocio">
          <option value="">Sin categorÃ­a</option>
          <option value="inmobiliaria">ğŸ  Inmobiliaria</option>
          <option value="transporte">ğŸš— Transporte</option>
          <option value="armamento">ğŸ”« Armamento</option>
          <option value="tecnologia">ğŸ’» TecnologÃ­a</option>
          <option value="finanzas">ğŸ’° Finanzas</option>
          <option value="entretenimiento">ğŸ° Entretenimiento</option>
          <option value="droga">ğŸ’Š FarmacÃ©utica</option>
          <option value="seguridad">ğŸ›¡ï¸ Seguridad</option>
          <option value="otro">ğŸ“¦ Otro</option>
        </select>
      </div>
      <div><label>LÃ­mite mÃ¡x. acc/cliente</label><input id="limiteAcciones" type="number" placeholder="Sin lÃ­mite" min="1"></div>
    </div>
    <label>URL imagen (opcional)</label>
    <input id="imagenNegocio" placeholder="https://...">
    <label>Notas internas</label>
    <textarea id="notasNegocio" placeholder="Notas sobre este negocio..."></textarea>
    <div class="btn-group">
      <button class="btn btn-green" onclick="agregarNegocio()">â• Agregar negocio</button>
    </div>
    <hr class="divider">
    <h2>ğŸ“‹ Lista de negocios</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
      <select id="filtroCategoria" style="width:auto;flex:1;min-width:150px;margin-top:0;" onchange="renderNegocios()">
        <option value="">Todas las categorÃ­as</option>
        <option value="inmobiliaria">ğŸ  Inmobiliaria</option>
        <option value="transporte">ğŸš— Transporte</option>
        <option value="armamento">ğŸ”« Armamento</option>
        <option value="tecnologia">ğŸ’» TecnologÃ­a</option>
        <option value="finanzas">ğŸ’° Finanzas</option>
        <option value="entretenimiento">ğŸ° Entretenimiento</option>
        <option value="droga">ğŸ’Š FarmacÃ©utica</option>
        <option value="seguridad">ğŸ›¡ï¸ Seguridad</option>
        <option value="otro">ğŸ“¦ Otro</option>
      </select>
      <select id="filtroEstado" style="width:auto;flex:1;min-width:150px;margin-top:0;" onchange="renderNegocios()">
        <option value="">Todos los estados</option>
        <option value="activa">ğŸŸ¢ Activa</option>
        <option value="suspendida">ğŸŸ¡ Suspendida</option>
        <option value="liquidacion">ğŸ”´ En liquidaciÃ³n</option>
      </select>
    </div>
    <div id="listaNegocios"><div class="empty"><span>ğŸ¢</span>No hay negocios</div></div>
  </div>

  <!-- CLIENTES -->
  <div class="panel" id="clientes">
    <h2>ğŸ‘¤ Agregar Cliente</h2>
    <div class="field-row">
      <div><label>Nombre</label><input id="nombreCliente" placeholder="Nombre del cliente"></div>
      <div><label>URL imagen (opcional)</label><input id="imagenCliente" placeholder="https://..."></div>
    </div>
    <label>Notas internas</label>
    <textarea id="notasCliente" placeholder="Notas sobre este cliente..."></textarea>
    <div class="btn-group">
      <button class="btn btn-green" onclick="agregarCliente()">â• Agregar cliente</button>
    </div>
    <hr class="divider">
    <h2>ğŸ“‹ Lista de clientes</h2>
    <input id="buscadorClientes" placeholder="ğŸ” Buscar cliente..." style="margin-bottom:10px;" oninput="renderClientes()">
    <div id="listaClientes"><div class="empty"><span>ğŸ‘¥</span>No hay clientes</div></div>
  </div>

  <!-- TRANSACCIONES -->
  <div class="panel" id="transacciones">
    <h2>ğŸ’± Nueva TransacciÃ³n</h2>
    <div class="field-row">
      <div><label>Negocio</label><select id="selectNegocioTrans" onchange="checkLimite()"><option value="">â€” Seleccionar â€”</option></select></div>
      <div><label>Cliente</label><select id="selectClienteTrans" onchange="checkLimite()"><option value="">â€” Seleccionar â€”</option></select></div>
    </div>
    <div class="field-row">
      <div><label>Cantidad de acciones</label><input id="cantidadAcciones" type="number" placeholder="0" min="1" oninput="checkLimite()"></div>
      <div><label>Tipo</label>
        <select id="tipoTrans">
          <option value="compra">ğŸŸ¢ Comprar (cliente adquiere)</option>
          <option value="venta">ğŸ”´ Vender (cliente devuelve)</option>
        </select>
      </div>
    </div>
    <div class="limit-warn" id="limitWarn"></div>
    <div id="transPreview" style="margin-top:12px;display:none;" class="result-section">
      <h3>Vista previa</h3>
      <div class="info-grid" id="transPreviewData"></div>
    </div>
    <div class="btn-group">
      <button class="btn btn-ghost" onclick="previewTransaccion()">ğŸ‘ï¸ Preview</button>
      <button class="btn btn-green" onclick="realizarTransaccion()">âœ… Confirmar</button>
    </div>
    <hr class="divider">
    <h2>ğŸ“œ Historial</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
      <select id="filtroTransNegocio" style="width:auto;flex:1;min-width:140px;margin-top:0;" onchange="renderTransacciones()"><option value="">Todos los negocios</option></select>
      <select id="filtroTransCliente" style="width:auto;flex:1;min-width:140px;margin-top:0;" onchange="renderTransacciones()"><option value="">Todos los clientes</option></select>
      <select id="filtroTransTipo" style="width:auto;flex:1;min-width:120px;margin-top:0;" onchange="renderTransacciones()">
        <option value="">Compras y ventas</option>
        <option value="compra">Solo compras</option>
        <option value="venta">Solo ventas</option>
      </select>
      <button class="btn btn-sm btn-blue" onclick="exportarCSV()">ğŸ“¥ CSV</button>
    </div>
    <div id="tablaTransacciones"></div>
  </div>

  <!-- BUSCAR -->
  <div class="panel" id="buscar">
    <h2>ğŸ” Buscar</h2>
    <div class="field-row">
      <div><label>Cliente</label><select id="selectBusquedaCliente"><option value="">â€” Ninguno â€”</option></select></div>
      <div><label>Negocio</label><select id="selectBusquedaNegocio"><option value="">â€” Ninguno â€”</option></select></div>
    </div>
    <div class="btn-group">
      <button class="btn btn-green" onclick="buscarSeleccion()">ğŸ” Buscar</button>
      <button class="btn btn-ghost" onclick="limpiarBusqueda()">âœ• Limpiar</button>
    </div>
    <div id="resultadoBusqueda"></div>
    <div class="chart-container" style="display:none;" id="chartContainer">
      <canvas id="chartAcciones"></canvas>
    </div>
  </div>

  <!-- RANKING -->
  <div class="panel" id="ranking">
    <h2>ğŸ† Ranking de Accionistas</h2>
    <div class="field-row">
      <div><label>Filtrar por negocio</label><select id="rankingFiltroNegocio" onchange="renderRanking()"><option value="">Todos los negocios</option></select></div>
      <div><label>Ordenar por</label>
        <select id="rankingOrden" onchange="renderRanking()">
          <option value="valor">ğŸ’° Valor de cartera</option>
          <option value="cantidad">ğŸ“Š Cantidad de acciones</option>
          <option value="negocios">ğŸ¢ NÂº de negocios</option>
        </select>
      </div>
    </div>
    <div id="rankingContainer" style="margin-top:16px;"></div>
  </div>

  <!-- ANUNCIOS -->
  <div class="panel" id="anuncios">
    <h2>ğŸ“¢ Nuevo Anuncio</h2>
    <p style="font-size:.8rem;color:var(--muted);margin-bottom:6px;">Los anuncios son visibles en la bolsa pÃºblica en tiempo real.</p>
    <div class="field-row">
      <div><label>TÃ­tulo</label><input id="anuncioTitulo" placeholder="TÃ­tulo del anuncio"></div>
      <div><label>Tipo</label>
        <select id="anuncioTipo">
          <option value="info">â„¹ï¸ InformaciÃ³n</option>
          <option value="alerta">âš ï¸ Alerta</option>
          <option value="urgente">ğŸš¨ Urgente</option>
          <option value="oferta">ğŸ’° Oferta</option>
        </select>
      </div>
    </div>
    <label>Contenido</label>
    <textarea id="anuncioTexto" placeholder="Escribe el anuncio..."></textarea>
    <div class="btn-group">
      <button class="btn btn-orange" onclick="publicarAnuncio()">ğŸ“¢ Publicar</button>
    </div>
    <hr class="divider">
    <h2>ğŸ“‹ Anuncios publicados</h2>
    <div id="listaAnuncios"><div class="empty"><span>ğŸ“¢</span>No hay anuncios</div></div>
  </div>

  <!-- PAPELERA -->
  <div class="panel" id="papelera">
    <h2>ğŸ—‘ï¸ Papelera de Reciclaje</h2>
    <p style="font-size:.82rem;color:var(--muted);margin-bottom:16px;">Puedes restaurar elementos o eliminarlos definitivamente.</p>
    <div class="btn-group" style="margin-bottom:16px;">
      <button class="btn btn-sm btn-ghost-red" onclick="vaciarPapelera()">ğŸ’€ Vaciar papelera</button>
    </div>
    <h3>Negocios eliminados</h3>
    <div id="papeleraNeg"><div class="empty"><span>âœ…</span>Sin negocios eliminados</div></div>
    <h3>Clientes eliminados</h3>
    <div id="papeleraCli"><div class="empty"><span>âœ…</span>Sin clientes eliminados</div></div>
  </div>

  <!-- LOGS -->
  <div class="panel" id="logs">
    <h2>ğŸ“‹ Sistema de Logs</h2>
    <div class="log-filters">
      <select id="logFiltroTipo" onchange="renderLogs()">
        <option value="">Todos los tipos</option>
        <option value="negocio">ğŸ¢ Negocio</option>
        <option value="cliente">ğŸ‘¤ Cliente</option>
        <option value="transaccion">ğŸ’± TransacciÃ³n</option>
        <option value="anuncio">ğŸ“¢ Anuncio</option>
      </select>
      <select id="logFiltroNegocio" onchange="renderLogs()"><option value="">Todos los negocios</option></select>
      <select id="logFiltroCliente" onchange="renderLogs()"><option value="">Todos los clientes</option></select>
      <input id="logBusqueda" placeholder="Buscar en logs..." oninput="renderLogs()">
      <button class="btn btn-sm btn-ghost-red" onclick="limpiarLogs()">ğŸ—‘ï¸ Limpiar</button>
    </div>
    <div id="logsContainer"></div>
    <div id="logsPaginacion"></div>
  </div>
</div>

<div id="popup"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, update, remove, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVJ5PrfRQpjPfgVXvlXGTrlaNLckaRY6U",
  authDomain: "reaganbroscompany.firebaseapp.com",
  databaseURL: "https://reaganbroscompany-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "reaganbroscompany",
  storageBucket: "reaganbroscompany.firebasestorage.app",
  messagingSenderId: "792852543624",
  appId: "1:792852543624:web:62e71a8704cb346f22873d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let clientesData={}, negociosData={}, transaccionesData={}, logsData={}, anunciosData={}, papeleraData={};

// --- LOGIN REAL CON FIREBASE AUTH ---
window.login = () => {
  const email = document.getElementById("loginEmail").value.trim();
  const pass = document.getElementById("loginPass").value.trim();
  const errorBtn = document.getElementById("loginError");

  signInWithEmailAndPassword(auth, email, pass)
    .then((userCredential) => {
      // El observador onAuthStateChanged se encargarÃ¡ de mostrar la app
      showPopup("ğŸ”“ Acceso concedido");
    })
    .catch((error) => {
      console.error(error);
      errorBtn.innerText = "Credenciales incorrectas o error de red.";
    });
};

// Observar si el usuario estÃ¡ logueado o no
onAuthStateChanged(auth, (user) => {
  if (user) {
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("appContainer").style.display = "block";
    iniciarListeners();
  } else {
    document.getElementById("loginOverlay").style.display = "flex";
    document.getElementById("appContainer").style.display = "none";
  }
});

document.getElementById("loginPass").addEventListener("keydown", e => { 
  if(e.key === "Enter") window.login(); 
});

const CATS={inmobiliaria:"ğŸ  Inmobiliaria",transporte:"ğŸš— Transporte",armamento:"ğŸ”« Armamento",
  tecnologia:"ğŸ’» TecnologÃ­a",finanzas:"ğŸ’° Finanzas",entretenimiento:"ğŸ° Entretenimiento",
  droga:"ğŸ’Š FarmacÃ©utica",seguridad:"ğŸ›¡ï¸ Seguridad",otro:"ğŸ“¦ Otro"};
const TIPOS_ANUNCIO={info:"â„¹ï¸",alerta:"âš ï¸",urgente:"ğŸš¨",oferta:"ğŸ’°"};



// POPUP
const popup=document.getElementById("popup");
function showPopup(msg){popup.innerText=msg;popup.style.display="block";setTimeout(()=>popup.style.display="none",2800);}

// MODAL
window.abrirModal=(html,titulo)=>{
  document.getElementById("modalContent").innerHTML=`<h2>${titulo}</h2>${html}`;
  document.getElementById("modalOverlay").classList.add("open");
};
window.cerrarModal=()=>document.getElementById("modalOverlay").classList.remove("open");
document.getElementById("modalOverlay").addEventListener("click",e=>{if(e.target.id==="modalOverlay")cerrarModal();});

// HELPERS
function fmtMoney(n){
  if(n>=1e6)return`$${(n/1e6).toFixed(2)}M`;
  if(n>=1e3)return`$${(n/1e3).toFixed(1)}K`;
  return`$${Number(n).toLocaleString("es-ES")}`;
}
function imgTag(url,fallback="ğŸ¢"){
  if(url)return`<img class="card-img" src="${url}" onerror="this.style.display='none'">`;
  return`<div class="card-img-placeholder">${fallback}</div>`;
}
function stockPct(d,t){if(!t)return 0;return Math.round((d/t)*100);}

// LISTENERS
function iniciarListeners(){
  onValue(ref(db,"negocios/"),snap=>{negociosData=snap.val()||{};renderNegocios();renderDashboard();actualizarSelects();renderRanking();});
  onValue(ref(db,"clientes/"),snap=>{clientesData=snap.val()||{};renderClientes();renderDashboard();actualizarSelects();renderRanking();});
  onValue(ref(db,"transacciones/"),snap=>{transaccionesData=snap.val()||{};renderTransacciones();renderDashboard();});
  onValue(ref(db,"logs/"),snap=>{logsData=snap.val()||{};renderLogs();});
  onValue(ref(db,"anuncios/"),snap=>{anunciosData=snap.val()||{};renderAnuncios();renderDashboard();});
  onValue(ref(db,"papelera/"),snap=>{papeleraData=snap.val()||{};renderPapelera();renderDashboard();});
}

// SELECTS
function actualizarSelects(){
  const nOpts=(ph)=>{let h=`<option value="">${ph}</option>`;for(let k in negociosData)h+=`<option value="${k}">${negociosData[k].nombre}</option>`;return h;};
  const cOpts=(ph)=>{let h=`<option value="">${ph}</option>`;for(let k in clientesData)h+=`<option value="${k}">${clientesData[k].nombre}</option>`;return h;};
  ["selectNegocioTrans","selectBusquedaNegocio","rankingFiltroNegocio","logFiltroNegocio"].forEach(id=>{const el=document.getElementById(id);if(el){const ph=el.options[0]?.text||"â€”";el.innerHTML=nOpts(ph);}});
  ["filtroTransNegocio"].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=nOpts("Todos los negocios");});
  ["selectClienteTrans","selectBusquedaCliente","logFiltroCliente"].forEach(id=>{const el=document.getElementById(id);if(el){const ph=el.options[0]?.text||"â€”";el.innerHTML=cOpts(ph);}});
  ["filtroTransCliente"].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=cOpts("Todos los clientes");});
}

// DASHBOARD
window.renderDashboard=function(){
  document.getElementById("statNegocios").textContent=Object.keys(negociosData).length;
  document.getElementById("statClientes").textContent=Object.keys(clientesData).length;
  const tArr=Object.values(transaccionesData);
  document.getElementById("statTransacciones").textContent=tArr.length;
  document.getElementById("statVolumen").textContent=fmtMoney(tArr.reduce((s,t)=>s+(t.precioTotal||0),0));
  document.getElementById("statAnuncios").textContent=Object.keys(anunciosData).length;
  const pN=papeleraData.negocios?Object.keys(papeleraData.negocios).length:0;
  const pC=papeleraData.clientes?Object.keys(papeleraData.clientes).length:0;
  document.getElementById("statPapelera").textContent=pN+pC;
  const cont=document.getElementById("dashboardNegocios");
  if(!Object.keys(negociosData).length){cont.innerHTML='<div class="empty"><span>ğŸ¢</span>Sin negocios</div>';return;}
  cont.innerHTML='';
  for(let k in negociosData){
    const n=negociosData[k];const total=n.accionesTotales||n.acciones;const pct=stockPct(n.acciones,total);
    cont.innerHTML+=`<div class="card">
      <div class="card-header">${imgTag(n.imagen)}
        <div><div class="card-title">${n.nombre}${n.categoria?` <span class="cat-pill">${CATS[n.categoria]||n.categoria}</span>`:''}</div>
          <div class="card-sub">${n.acciones} disp. / ${total} total Â· ${fmtMoney(n.valorAccion)}/acc</div>
        </div>
        <div class="card-actions">
          <span class="status-${n.estado||"activa"}">${(n.estado||"activa").toUpperCase()}</span>
          <span class="badge ${pct>50?"badge-green":pct>20?"badge-orange":"badge-red"}">${pct}% libre</span>
        </div>
      </div>
      <div class="stock-bar"><div class="stock-track"><div class="stock-fill" style="width:${pct}%"></div></div></div>
    </div>`;
  }
};

// NEGOCIOS
window.renderNegocios=function(){
  const cont=document.getElementById("listaNegocios");
  const filtCat=document.getElementById("filtroCategoria").value;
  const filtEst=document.getElementById("filtroEstado").value;
  const negs=Object.entries(negociosData).filter(([k,n])=>{
    if(filtCat&&n.categoria!==filtCat)return false;
    if(filtEst&&(n.estado||"activa")!==filtEst)return false;
    return true;
  });
  if(!negs.length){cont.innerHTML='<div class="empty"><span>ğŸ¢</span>No hay negocios</div>';return;}
  cont.innerHTML='';
  negs.forEach(([k,n])=>{
    const total=n.accionesTotales||n.acciones;const pct=stockPct(n.acciones,total);
    cont.innerHTML+=`<div class="card" id="card-neg-${k}">
      <div class="card-header">${imgTag(n.imagen)}
        <div><div class="card-title">${n.nombre}${n.categoria?` <span class="cat-pill">${CATS[n.categoria]||n.categoria}</span>`:''}</div>
          <div class="card-sub">${n.acciones} disp. / ${total} total Â· ${fmtMoney(n.valorAccion)}/acc${n.limiteAcciones?` Â· LÃ­m: ${n.limiteAcciones}`:''}</div>
        </div>
        <div class="card-actions">
          <span class="status-${n.estado||"activa"}">${(n.estado||"activa").toUpperCase()}</span>
          <button class="btn btn-sm btn-ghost" onclick="toggleCard('card-neg-${k}')">âœï¸ Editar</button>
          <button class="btn btn-sm btn-ghost" onclick="abrirGraficaPrecio('${k}')">ğŸ“ˆ</button>
          <button class="btn btn-sm btn-ghost-red" onclick="eliminarNegocio('${k}')">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="stock-bar">
        <div class="stock-bar-label"><span>Disponibilidad</span><span>${n.acciones}/${total} (${pct}%)</span></div>
        <div class="stock-track"><div class="stock-fill" style="width:${pct}%"></div></div>
      </div>
      ${n.notas?`<div class="nota-display">${n.notas}</div>`:''}
      <div class="card-body">
        <div class="card-inputs">
          <div><label>Nombre</label><input class="edit-nombre" value="${n.nombre}"></div>
          <div><label>Acciones disponibles</label><input class="edit-acciones" type="number" value="${n.acciones}"></div>
          <div><label>Acciones totales</label><input class="edit-acciones-total" type="number" value="${total}"></div>
          <div><label>Valor acciÃ³n ($)</label><input class="edit-valor" type="number" value="${n.valorAccion}"></div>
          <div><label>Estado</label><select class="edit-estado">
            <option value="activa" ${(n.estado||"activa")==="activa"?"selected":""}>ğŸŸ¢ Activa</option>
            <option value="suspendida" ${n.estado==="suspendida"?"selected":""}>ğŸŸ¡ Suspendida</option>
            <option value="liquidacion" ${n.estado==="liquidacion"?"selected":""}>ğŸ”´ En liquidaciÃ³n</option>
          </select></div>
          <div><label>CategorÃ­a</label><select class="edit-categoria">
            <option value="">Sin categorÃ­a</option>
            ${Object.entries(CATS).map(([v,l])=>`<option value="${v}" ${n.categoria===v?"selected":""}>${l}</option>`).join('')}
          </select></div>
          <div><label>LÃ­mite acc./cliente</label><input class="edit-limite" type="number" value="${n.limiteAcciones||''}" placeholder="Sin lÃ­mite"></div>
          <div><label>URL imagen</label><input class="edit-imagen" value="${n.imagen||''}"></div>
        </div>
        <label>Notas internas</label>
        <textarea class="edit-notas">${n.notas||''}</textarea>
        <div class="btn-group">
          <button class="btn btn-sm btn-green" onclick="guardarNegocio('${k}')">âœ… Guardar</button>
          <button class="btn btn-sm btn-blue" onclick="actualizarPrecioConHistorial('${k}')">ğŸ“ˆ Guardar precio + historial</button>
        </div>
      </div>
    </div>`;
  });
};

window.agregarNegocio=()=>{
  const id=document.getElementById("idNegocio").value.trim().replace(/\s/g,"-");
  const nombre=document.getElementById("nombreNegocio").value.trim();
  const acciones=Number(document.getElementById("accionesNegocio").value);
  const valorAccion=Number(document.getElementById("valorAccion").value);
  const imagen=document.getElementById("imagenNegocio").value.trim();
  const categoria=document.getElementById("categoriaNegocio").value;
  const limite=document.getElementById("limiteAcciones").value;
  const notas=document.getElementById("notasNegocio").value.trim();
  if(!id||!nombre||isNaN(acciones)||acciones<=0||isNaN(valorAccion)||valorAccion<=0)return alert("Rellena todos los campos");
  const obj={nombre,acciones,accionesTotales:acciones,valorAccion,imagen,categoria,notas,estado:"activa"};
  if(limite)obj.limiteAcciones=Number(limite);
  set(ref(db,"negocios/"+id),obj).then(()=>{
    ["idNegocio","nombreNegocio","accionesNegocio","valorAccion","imagenNegocio","notasNegocio"].forEach(i=>document.getElementById(i).value="");
    showPopup("âœ… Negocio agregado!");
    logAccion(`Negocio creado: ${nombre} (${id})`,"negocio",id,null);
    push(ref(db,`negocios/${id}/valorHistorial`),{ts:Date.now(),precio:valorAccion});
  });
};

window.guardarNegocio=(key)=>{
  const c=document.getElementById("card-neg-"+key);
  const nombre=c.querySelector(".edit-nombre").value;
  const acciones=Number(c.querySelector(".edit-acciones").value);
  const accionesTotales=Number(c.querySelector(".edit-acciones-total").value);
  const valorAccion=Number(c.querySelector(".edit-valor").value);
  const imagen=c.querySelector(".edit-imagen").value;
  const estado=c.querySelector(".edit-estado").value;
  const categoria=c.querySelector(".edit-categoria").value;
  const limiteEl=c.querySelector(".edit-limite").value;
  const notas=c.querySelector(".edit-notas").value;
  const obj={nombre,acciones,accionesTotales,valorAccion,imagen,estado,categoria,notas};
  if(limiteEl)obj.limiteAcciones=Number(limiteEl);else obj.limiteAcciones=null;
  update(ref(db,"negocios/"+key),obj).then(()=>{showPopup("âœï¸ Negocio actualizado!");logAccion(`Negocio editado: ${nombre}`,"negocio",key,null);});
};

window.actualizarPrecioConHistorial=(key)=>{
  const c=document.getElementById("card-neg-"+key);
  const valorAccion=Number(c.querySelector(".edit-valor").value);
  const nombre=c.querySelector(".edit-nombre").value;
  if(isNaN(valorAccion)||valorAccion<=0)return alert("Introduce un precio vÃ¡lido");
  update(ref(db,`negocios/${key}`),{valorAccion}).then(()=>{
    push(ref(db,`negocios/${key}/valorHistorial`),{ts:Date.now(),precio:valorAccion});
    showPopup("ğŸ“ˆ Precio actualizado con historial!");
    logAccion(`Precio actualizado: ${nombre} â†’ ${fmtMoney(valorAccion)}`,"negocio",key,null);
  });
};

window.abrirGraficaPrecio=async(key)=>{
  const n=negociosData[key];
  const snap=await get(ref(db,`negocios/${key}/valorHistorial/`));
  const raw=snap.val()||{};
  // Soporta tanto formato nuevo {ts,precio} como legado {fecha:valor}
  let puntos=Object.values(raw).map(v=>{
    if(typeof v==="object"&&v.ts)return{ts:v.ts,precio:v.precio};
    return null;
  }).filter(Boolean).sort((a,b)=>a.ts-b.ts);
  const cid="mc_"+key+"_"+Date.now();
  const precioActual=n.valorAccion;
  abrirModal(`
    <p style="color:var(--muted);font-size:.82rem;margin-bottom:12px;">
      Historial de precio: <strong style="color:var(--green)">${n.nombre}</strong>
      &nbsp;Â·&nbsp; Precio actual: <strong style="color:var(--green)">${fmtMoney(precioActual)}</strong>
    </p>
    ${puntos.length<2
      ?`<div class="empty"><span>ğŸ“Š</span>Necesitas al menos 2 cambios de precio registrados.<br>
        <small style="color:var(--muted)">Usa "Guardar precio + historial" cada vez que cambies el precio.</small></div>`
      :`<div style="position:relative;height:300px;"><canvas id="${cid}"></canvas></div>`}
  `,"ğŸ“ˆ Historial de precios");
  if(puntos.length>=2){
    setTimeout(()=>{
      const ctx=document.getElementById(cid)?.getContext("2d");
      if(!ctx)return;
      const labels=puntos.map(p=>{
        const d=new Date(p.ts);
        return d.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit"})+" "+d.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});
      });
      const valores=puntos.map(p=>p.precio);
      const ultimo=valores[valores.length-1];
      const primero=valores[0];
      const subida=ultimo>=primero;
      const color=subida?"#00ff99":"#ff3344";
      new Chart(ctx,{
        type:"line",
        data:{labels,datasets:[{
          label:"Precio acciÃ³n",
          data:valores,
          borderColor:color,
          backgroundColor:color+"18",
          fill:true,
          tension:.3,
          pointRadius:3,
          pointBackgroundColor:color,
          pointBorderColor:"#000",
          pointHoverRadius:6,
          borderWidth:2
        }]},
        options:{
          responsive:true,maintainAspectRatio:false,
          interaction:{mode:"index",intersect:false},
          plugins:{
            legend:{display:false},
            tooltip:{
              backgroundColor:"#1a1a1a",
              borderColor:color,borderWidth:1,
              titleColor:"#888",bodyColor:"#f0f0f0",
              callbacks:{label:ctx=>`  $${ctx.parsed.y.toLocaleString("es-ES")}`}
            },
            annotation:{
              annotations:{
                lineActual:{type:"line",yMin:precioActual,yMax:precioActual,
                  borderColor:"#ff993388",borderWidth:1,borderDash:[4,4],
                  label:{content:`Actual: ${fmtMoney(precioActual)}`,enabled:true,
                    position:"end",color:"#ff9933",font:{size:10}}}
              }
            }
          },
          scales:{
            x:{ticks:{color:"#666",maxRotation:45,font:{size:10}},grid:{color:"#ffffff0a"}},
            y:{ticks:{color:"#888",callback:v=>`$${v.toLocaleString("es-ES")}`},grid:{color:"#ffffff11"}}
          }
        }
      });
    },80);
  }
};

window.eliminarNegocio=(key)=>{
  if(!confirm("Â¿Mover a la papelera?"))return;
  const n=negociosData[key];
  push(ref(db,"papelera/negocios/"),{...n,_id:key,_fechaEliminado:Date.now()}).then(()=>{
    remove(ref(db,"negocios/"+key)).then(()=>{showPopup("ğŸ—‘ï¸ Negocio a papelera");logAccion(`Negocio eliminado: ${n.nombre}`,"negocio",key,null);});
  });
};

// CLIENTES
window.renderClientes=function(){
  const cont=document.getElementById("listaClientes");
  const busq=(document.getElementById("buscadorClientes").value||"").toLowerCase();
  const clis=Object.entries(clientesData).filter(([k,c])=>!busq||c.nombre.toLowerCase().includes(busq));
  if(!clis.length){cont.innerHTML='<div class="empty"><span>ğŸ‘¥</span>No hay clientes</div>';return;}
  cont.innerHTML='';
  clis.forEach(([k,c])=>{
    const acciones=c.acciones||{};
    const totalAcc=Object.values(acciones).reduce((s,v)=>s+v,0);
    const totalValor=Object.entries(acciones).reduce((s,[nId,qty])=>{const n=negociosData[nId];return s+(n?qty*n.valorAccion:0);},0);
    let holdingsHTML='';
    for(let nk in acciones){if(acciones[nk]>0){const n=negociosData[nk];
      holdingsHTML+=`<div class="holding-row"><span>${n?n.nombre:nk}</span><span>${acciones[nk]} acc. Â· ${fmtMoney(n?acciones[nk]*n.valorAccion:0)}</span></div>`;}}
    if(!holdingsHTML)holdingsHTML='<div style="color:var(--muted);padding:8px 0;">Sin acciones</div>';
    cont.innerHTML+=`<div class="card" id="card-cli-${k}">
      <div class="card-header">${imgTag(c.imagen,"ğŸ‘¤")}
        <div><div class="card-title">${c.nombre}</div>
          <div class="card-sub">${totalAcc} acciones Â· Valor: ${fmtMoney(totalValor)}</div>
        </div>
        <div class="card-actions">
          <button class="btn btn-sm btn-ghost" onclick="toggleCard('card-cli-${k}')">ğŸ“Š Ver</button>
          <button class="btn btn-sm btn-ghost-red" onclick="eliminarCliente('${k}')">ğŸ—‘ï¸</button>
        </div>
      </div>
      ${c.notas?`<div class="nota-display">${c.notas}</div>`:''}
      <div class="card-body">
        <div class="holdings-list">${holdingsHTML}</div>
        <div class="card-inputs" style="margin-top:12px;">
          <div><label>Nombre</label><input class="edit-nombre" value="${c.nombre}"></div>
          <div><label>URL imagen</label><input class="edit-imagen" value="${c.imagen||''}"></div>
        </div>
        <label>Notas internas</label>
        <textarea class="edit-notas">${c.notas||''}</textarea>
        <div class="btn-group"><button class="btn btn-sm btn-green" onclick="guardarCliente('${k}')">âœ… Guardar</button></div>
      </div>
    </div>`;
  });
};

window.agregarCliente=()=>{
  const nombre=document.getElementById("nombreCliente").value.trim();
  const imagen=document.getElementById("imagenCliente").value.trim();
  const notas=document.getElementById("notasCliente").value.trim();
  if(!nombre)return alert("Nombre obligatorio");
  const r=push(ref(db,"clientes/"));
  set(r,{nombre,imagen,notas}).then(()=>{
    ["nombreCliente","imagenCliente","notasCliente"].forEach(i=>document.getElementById(i).value="");
    showPopup("ğŸ‘¥ Cliente agregado!");logAccion(`Cliente creado: ${nombre}`,"cliente",null,r.key);
  });
};

window.guardarCliente=(key)=>{
  const c=document.getElementById("card-cli-"+key);
  update(ref(db,"clientes/"+key),{
    nombre:c.querySelector(".edit-nombre").value,
    imagen:c.querySelector(".edit-imagen").value,
    notas:c.querySelector(".edit-notas").value
  }).then(()=>{showPopup("âœï¸ Cliente actualizado");logAccion(`Cliente editado: ${c.querySelector(".edit-nombre").value}`,"cliente",null,key);});
};

window.eliminarCliente=(key)=>{
  if(!confirm("Â¿Mover a la papelera?"))return;
  const c=clientesData[key];
  push(ref(db,"papelera/clientes/"),{...c,_id:key,_fechaEliminado:Date.now()}).then(()=>{
    remove(ref(db,"clientes/"+key)).then(()=>{showPopup("ğŸ—‘ï¸ Cliente a papelera");logAccion(`Cliente eliminado: ${c.nombre}`,"cliente",null,key);});
  });
};

// TRANSACCIONES
window.checkLimite=function(){
  const nId=document.getElementById("selectNegocioTrans").value;
  const cId=document.getElementById("selectClienteTrans").value;
  const cantidad=Number(document.getElementById("cantidadAcciones").value);
  const warn=document.getElementById("limitWarn");
  warn.style.display="none";
  if(!nId||!cId||!cantidad)return;
  const n=negociosData[nId],c=clientesData[cId];if(!n||!c)return;
  if(n.limiteAcciones){
    const actual=(c.acciones||{})[nId]||0;
    if(actual+cantidad>n.limiteAcciones){
      warn.style.display="block";
      warn.textContent=`âš ï¸ LÃ­mite: ${c.nombre} tiene ${actual} acc. El lÃ­mite es ${n.limiteAcciones}. Puede comprar ${Math.max(0,n.limiteAcciones-actual)} mÃ¡s.`;
    }
  }
};

window.previewTransaccion=function(){
  const nId=document.getElementById("selectNegocioTrans").value;
  const cId=document.getElementById("selectClienteTrans").value;
  const cantidad=Number(document.getElementById("cantidadAcciones").value);
  const tipo=document.getElementById("tipoTrans").value;
  const preview=document.getElementById("transPreview");
  if(!nId||!cId||!cantidad){preview.style.display="none";return;}
  const n=negociosData[nId],c=clientesData[cId];if(!n||!c)return;
  const precio=cantidad*n.valorAccion;
  const acc=(c.acciones||{})[nId]||0;
  document.getElementById("transPreviewData").innerHTML=`
    <div class="info-item"><div class="key">Negocio</div><div class="val">${n.nombre}</div></div>
    <div class="info-item"><div class="key">Cliente</div><div class="val">${c.nombre}</div></div>
    <div class="info-item"><div class="key">Tipo</div><div class="val">${tipo==="compra"?"ğŸŸ¢ Compra":"ğŸ”´ Venta"}</div></div>
    <div class="info-item"><div class="key">Precio total</div><div class="val">${fmtMoney(precio)}</div></div>
    <div class="info-item"><div class="key">Acc. cliente â†’ despuÃ©s</div><div class="val">${acc} â†’ ${tipo==="compra"?acc+cantidad:acc-cantidad}</div></div>
    <div class="info-item"><div class="key">Disp. negocio â†’ despuÃ©s</div><div class="val">${n.acciones} â†’ ${tipo==="compra"?n.acciones-cantidad:n.acciones+cantidad}</div></div>`;
  preview.style.display="block";
};

window.realizarTransaccion=()=>{
  const nId=document.getElementById("selectNegocioTrans").value;
  const cId=document.getElementById("selectClienteTrans").value;
  const cantidad=Number(document.getElementById("cantidadAcciones").value);
  const tipo=document.getElementById("tipoTrans").value;
  if(!nId||!cId||isNaN(cantidad)||cantidad<=0)return alert("Rellena todos los campos");
  const n=negociosData[nId],c=clientesData[cId];
  const cliAcc={...(c.acciones||{})};
  const accCli=cliAcc[nId]||0;
  let nuevasAccNeg=n.acciones;
  if(tipo==="compra"){
    if(n.estado&&n.estado!=="activa")return alert(`âŒ El negocio estÃ¡ ${n.estado}`);
    if(n.acciones<cantidad)return alert(`âŒ Solo hay ${n.acciones} acciones disponibles`);
    if(n.limiteAcciones&&(accCli+cantidad)>n.limiteAcciones)return alert(`âŒ LÃ­mite: max ${n.limiteAcciones} acciones por cliente`);
    cliAcc[nId]=accCli+cantidad;nuevasAccNeg-=cantidad;
  }else{
    if(accCli<cantidad)return alert(`âŒ ${c.nombre} solo tiene ${accCli} acciones`);
    cliAcc[nId]=accCli-cantidad;nuevasAccNeg+=cantidad;
  }
  const precioTotal=cantidad*n.valorAccion;
  const updates={};
  updates[`clientes/${cId}/acciones`]=cliAcc;
  updates[`negocios/${nId}/acciones`]=nuevasAccNeg;
  update(ref(db),updates).then(()=>{
    push(ref(db,"transacciones/"),{negocio:nId,cliente:cId,cantidad,tipo,precioTotal,fecha:Date.now()});
    showPopup(`ğŸ’± ${tipo==="compra"?`${c.nombre} paga ${fmtMoney(precioTotal)}`:`${c.nombre} recibe ${fmtMoney(precioTotal)}`}`);
    logAccion(`${tipo==="compra"?"Compra":"Venta"}: ${c.nombre} ${tipo==="compra"?"comprÃ³":"vendiÃ³"} ${cantidad} acc. de ${n.nombre} (${fmtMoney(precioTotal)})`,"transaccion",nId,cId);
    document.getElementById("cantidadAcciones").value="";document.getElementById("transPreview").style.display="none";
  });
};

window.renderTransacciones=function(){
  const cont=document.getElementById("tablaTransacciones");
  const fN=document.getElementById("filtroTransNegocio").value;
  const fC=document.getElementById("filtroTransCliente").value;
  const fT=document.getElementById("filtroTransTipo").value;
  const trans=Object.entries(transaccionesData).map(([k,v])=>({key:k,...v}))
    .filter(t=>(!fN||t.negocio===fN)&&(!fC||t.cliente===fC)&&(!fT||t.tipo===fT))
    .sort((a,b)=>b.fecha-a.fecha);
  if(!trans.length){cont.innerHTML='<div class="empty"><span>ğŸ’±</span>Sin transacciones</div>';return;}
  let html=`<table class="trans-table"><thead><tr><th>Fecha</th><th>Tipo</th><th>Negocio</th><th>Cliente</th><th>Cant.</th><th>Total</th></tr></thead><tbody>`;
  trans.forEach(t=>{
    const n=negociosData[t.negocio]?.nombre||t.negocio;
    const c=clientesData[t.cliente]?.nombre||t.cliente;
    const badge=t.tipo==="compra"?'<span class="badge badge-green">COMPRA</span>':'<span class="badge badge-red">VENTA</span>';
    html+=`<tr><td>${new Date(t.fecha).toLocaleString("es-ES")}</td><td>${badge}</td><td>${n}</td><td>${c}</td><td>${t.cantidad}</td><td>${fmtMoney(t.precioTotal)}</td></tr>`;
  });
  cont.innerHTML=html+"</tbody></table>";
};

window.exportarCSV=function(){
  const fN=document.getElementById("filtroTransNegocio").value;
  const fC=document.getElementById("filtroTransCliente").value;
  const fT=document.getElementById("filtroTransTipo").value;
  const trans=Object.values(transaccionesData)
    .filter(t=>(!fN||t.negocio===fN)&&(!fC||t.cliente===fC)&&(!fT||t.tipo===fT))
    .sort((a,b)=>b.fecha-a.fecha);
  let csv="Fecha,Tipo,Negocio,Cliente,Cantidad,Precio Total\n";
  trans.forEach(t=>{
    const n=negociosData[t.negocio]?.nombre||t.negocio;
    const c=clientesData[t.cliente]?.nombre||t.cliente;
    csv+=`"${new Date(t.fecha).toLocaleString("es-ES")}","${t.tipo}","${n}","${c}",${t.cantidad},${t.precioTotal}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8;"}));
  a.download=`transacciones_${new Date().toISOString().split("T")[0]}.csv`;
  a.click();showPopup("ğŸ“¥ CSV exportado!");
};

// BUSCAR
window.buscarSeleccion=function(){
  const cId=document.getElementById("selectBusquedaCliente").value;
  const nId=document.getElementById("selectBusquedaNegocio").value;
  const cont=document.getElementById("resultadoBusqueda");
  const chartCont=document.getElementById("chartContainer");
  cont.innerHTML="";chartCont.style.display="none";
  if(!cId&&!nId){cont.innerHTML='<div class="empty"><span>ğŸ”</span>Selecciona un cliente o negocio</div>';return;}
  if(cId){
    const c=clientesData[cId];if(!c)return;
    const acciones=c.acciones||{};
    let holdingsHTML="",totalValor=0;
    for(let nk in acciones){if(acciones[nk]>0){const n=negociosData[nk];const v=n?acciones[nk]*n.valorAccion:0;totalValor+=v;
      holdingsHTML+=`<div class="holding-row"><span>${n?n.nombre:nk}</span><span>${acciones[nk]} acc. Â· ${fmtMoney(v)}</span></div>`;}}
    if(!holdingsHTML)holdingsHTML='<div style="color:var(--muted);padding:8px 0;">Sin acciones</div>';
    const transC=Object.values(transaccionesData).filter(t=>t.cliente===cId).sort((a,b)=>b.fecha-a.fecha).slice(0,10);
    const transHTML=transC.map(t=>{
      const n=negociosData[t.negocio]?.nombre||t.negocio;
      const badge=t.tipo==="compra"?'<span class="badge badge-green">C</span>':'<span class="badge badge-red">V</span>';
      return`<div class="holding-row">${badge} ${n} Â· ${t.cantidad} acc. Â· ${fmtMoney(t.precioTotal)} Â· <small style="color:var(--muted)">${new Date(t.fecha).toLocaleDateString("es-ES")}</small></div>`;
    }).join("")||'<div style="color:var(--muted);padding:8px 0;">Sin transacciones</div>';
    cont.innerHTML+=`<div class="result-section"><h3>ğŸ‘¤ ${c.nombre}</h3>
      ${c.notas?`<div class="nota-display">${c.notas}</div>`:''}
      <div class="info-grid">
        <div class="info-item"><div class="key">Valor total cartera</div><div class="val">${fmtMoney(totalValor)}</div></div>
        <div class="info-item"><div class="key">Negocios en cartera</div><div class="val">${Object.values(acciones).filter(v=>v>0).length}</div></div>
      </div>
      <div style="margin-top:12px;"><div style="font-size:.78rem;color:var(--muted);margin-bottom:6px;">ACCIONES POR NEGOCIO</div><div class="holdings-list">${holdingsHTML}</div></div>
      <div style="margin-top:12px;"><div style="font-size:.78rem;color:var(--muted);margin-bottom:6px;">ÃšLTIMAS TRANSACCIONES</div><div class="holdings-list">${transHTML}</div></div>
    </div>`;
  }
  if(nId){
    const n=negociosData[nId];if(!n)return;
    const total=n.accionesTotales||n.acciones;const pct=stockPct(n.acciones,total);
    let shareholders=[];
    for(let cId2 in clientesData){const c=clientesData[cId2];const acc=(c.acciones||{})[nId]||0;
      if(acc>0)shareholders.push({nombre:c.nombre,acc,valor:acc*n.valorAccion,pct:Math.round(acc/total*100)});}
    shareholders.sort((a,b)=>b.acc-a.acc);
    const shHTML=shareholders.map(s=>`<div class="holding-row"><span>${s.nombre}</span><span>${s.acc} acc. (${s.pct}%) Â· ${fmtMoney(s.valor)}</span></div>`).join("")
      ||'<div style="color:var(--muted);padding:8px 0;">Sin accionistas</div>';
    const transN=Object.values(transaccionesData).filter(t=>t.negocio===nId).sort((a,b)=>b.fecha-a.fecha).slice(0,10);
    const transHTML=transN.map(t=>{
      const c=clientesData[t.cliente]?.nombre||t.cliente;
      const badge=t.tipo==="compra"?'<span class="badge badge-green">C</span>':'<span class="badge badge-red">V</span>';
      return`<div class="holding-row">${badge} ${c} Â· ${t.cantidad} acc. Â· ${fmtMoney(t.precioTotal)} Â· <small style="color:var(--muted)">${new Date(t.fecha).toLocaleDateString("es-ES")}</small></div>`;
    }).join("")||'<div style="color:var(--muted);padding:8px 0;">Sin transacciones</div>';
    cont.innerHTML+=`<div class="result-section"><h3>ğŸ¢ ${n.nombre}${n.categoria?` <span class="cat-pill">${CATS[n.categoria]||n.categoria}</span>`:''}</h3>
      ${n.notas?`<div class="nota-display">${n.notas}</div>`:''}
      <div class="info-grid">
        <div class="info-item"><div class="key">Acciones disponibles</div><div class="val">${n.acciones}</div></div>
        <div class="info-item"><div class="key">Acciones totales</div><div class="val">${total}</div></div>
        <div class="info-item"><div class="key">Acciones vendidas</div><div class="val">${total-n.acciones}</div></div>
        <div class="info-item"><div class="key">Valor por acciÃ³n</div><div class="val">${fmtMoney(n.valorAccion)}</div></div>
        <div class="info-item"><div class="key">Cap. de mercado</div><div class="val">${fmtMoney(total*n.valorAccion)}</div></div>
        <div class="info-item"><div class="key">Estado</div><div class="val"><span class="status-${n.estado||"activa"}">${(n.estado||"activa").toUpperCase()}</span></div></div>
      </div>
      <div class="stock-bar" style="margin-top:10px;"><div class="stock-track" style="height:12px;"><div class="stock-fill" style="width:${pct}%"></div></div></div>
      <div style="margin-top:12px;"><div style="font-size:.78rem;color:var(--muted);margin-bottom:6px;">ACCIONISTAS</div><div class="holdings-list">${shHTML}</div></div>
      <div style="margin-top:12px;"><div style="font-size:.78rem;color:var(--muted);margin-bottom:6px;">ÃšLTIMAS TRANSACCIONES</div><div class="holdings-list">${transHTML}</div></div>
    </div>`;
    get(ref(db,"negocios/"+nId+"/valorHistorial/")).then(snap=>{
      const raw=snap.val()||{};
      const puntos=Object.values(raw).map(v=>typeof v==="object"&&v.ts?v:null).filter(Boolean).sort((a,b)=>a.ts-b.ts);
      if(puntos.length>=2){
        chartCont.style.display="block";
        if(chartAccion)chartAccion.destroy();
        const labels=puntos.map(p=>{const d=new Date(p.ts);return d.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit"})+" "+d.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});});
        const valores=puntos.map(p=>p.precio);
        const precioActual=n.valorAccion;
        const ultimo=valores[valores.length-1];
        const color=ultimo>=(valores[0]||0)?"#00ff99":"#ff3344";
        chartAccion=new Chart(document.getElementById("chartAcciones").getContext("2d"),{
          type:"line",
          data:{labels,datasets:[{label:"Precio acciÃ³n",data:valores,borderColor:color,
            backgroundColor:color+"18",fill:true,tension:.3,pointRadius:3,
            pointBackgroundColor:color,borderWidth:2}]},
          options:{responsive:true,maintainAspectRatio:false,
            interaction:{mode:"index",intersect:false},
            plugins:{
              legend:{display:false},
              tooltip:{backgroundColor:"#1a1a1a",borderColor:color,borderWidth:1,
                titleColor:"#888",bodyColor:"#f0f0f0",
                callbacks:{label:c=>`  $${c.parsed.y.toLocaleString("es-ES")}`}}
            },
            scales:{
              x:{ticks:{color:"#666",maxRotation:45,font:{size:10}},grid:{color:"#ffffff0a"}},
              y:{ticks:{color:"#888",callback:v=>`$${v.toLocaleString("es-ES")}`},grid:{color:"#ffffff11"}}
            }}});
      }
    });
  }
};
window.limpiarBusqueda=function(){
  document.getElementById("selectBusquedaCliente").value="";
  document.getElementById("selectBusquedaNegocio").value="";
  document.getElementById("resultadoBusqueda").innerHTML="";
  document.getElementById("chartContainer").style.display="none";
};

// RANKING
window.renderRanking=function(){
  const cont=document.getElementById("rankingContainer");
  const filtroN=document.getElementById("rankingFiltroNegocio").value;
  const orden=document.getElementById("rankingOrden").value;
  let ranking=Object.entries(clientesData).map(([k,c])=>{
    const acciones=c.acciones||{};
    let totalAcc=0,totalValor=0,numNegocios=0;
    for(let nId in acciones){if(!filtroN||nId===filtroN){const qty=acciones[nId]||0;const n=negociosData[nId];
      totalAcc+=qty;if(n)totalValor+=qty*n.valorAccion;if(qty>0)numNegocios++;}}
    return{key:k,nombre:c.nombre,imagen:c.imagen,totalAcc,totalValor,numNegocios};
  }).filter(r=>r.totalAcc>0);
  if(orden==="valor")ranking.sort((a,b)=>b.totalValor-a.totalValor);
  else if(orden==="cantidad")ranking.sort((a,b)=>b.totalAcc-a.totalAcc);
  else ranking.sort((a,b)=>b.numNegocios-a.numNegocios);
  if(!ranking.length){cont.innerHTML='<div class="empty"><span>ğŸ†</span>Sin datos</div>';return;}
  cont.innerHTML=ranking.map((r,i)=>{
    const nc=i===0?"gold":i===1?"silver":i===2?"bronze":"";
    const img=r.imagen?`<img class="card-img" src="${r.imagen}" style="width:40px;height:40px;" onerror="this.style.display='none'">`:`<div class="card-img-placeholder" style="width:40px;height:40px;font-size:1rem;">ğŸ‘¤</div>`;
    return`<div class="rank-row">${img}<div class="rank-num ${nc}">${i+1}</div>
      <div class="rank-info"><div class="rank-name">${r.nombre}</div>
        <div class="rank-detail">${r.totalAcc} acc. Â· ${r.numNegocios} negocio${r.numNegocios!==1?"s":""}</div>
      </div><div class="rank-val">${fmtMoney(r.totalValor)}</div></div>`;
  }).join("");
};

// ANUNCIOS
window.publicarAnuncio=()=>{
  const titulo=document.getElementById("anuncioTitulo").value.trim();
  const texto=document.getElementById("anuncioTexto").value.trim();
  const tipo=document.getElementById("anuncioTipo").value;
  if(!titulo||!texto)return alert("TÃ­tulo y contenido obligatorios");
  push(ref(db,"anuncios/"),{titulo,texto,tipo,fecha:Date.now()}).then(()=>{
    ["anuncioTitulo","anuncioTexto"].forEach(i=>document.getElementById(i).value="");
    showPopup("ğŸ“¢ Anuncio publicado!");logAccion(`Anuncio publicado: ${titulo}`,"anuncio",null,null);
  });
};
window.renderAnuncios=function(){
  const cont=document.getElementById("listaAnuncios");
  const anuncios=Object.entries(anunciosData).sort((a,b)=>b[1].fecha-a[1].fecha);
  if(!anuncios.length){cont.innerHTML='<div class="empty"><span>ğŸ“¢</span>No hay anuncios</div>';return;}
  cont.innerHTML=anuncios.map(([k,a])=>`<div class="anuncio-card">
    <div class="anuncio-header">
      <div><div class="anuncio-titulo">${TIPOS_ANUNCIO[a.tipo]||"ğŸ“Œ"} ${a.titulo}</div>
        <div class="anuncio-fecha">${new Date(a.fecha).toLocaleString("es-ES")}</div>
      </div>
      <button class="btn btn-sm btn-ghost-red" onclick="eliminarAnuncio('${k}')">âœ•</button>
    </div>
    <div class="anuncio-texto">${a.texto}</div>
  </div>`).join("");
};
window.eliminarAnuncio=(key)=>remove(ref(db,"anuncios/"+key)).then(()=>showPopup("ğŸ—‘ï¸ Anuncio eliminado"));

// PAPELERA
window.renderPapelera=function(){
  const negItems=papeleraData.negocios?Object.entries(papeleraData.negocios):[];
  const cliItems=papeleraData.clientes?Object.entries(papeleraData.clientes):[];
  document.getElementById("papeleraNeg").innerHTML=!negItems.length
    ?'<div class="empty"><span>âœ…</span>Sin negocios eliminados</div>'
    :negItems.map(([k,n])=>`<div class="trash-card">
      <div><div class="trash-name">ğŸ¢ ${n.nombre}</div>
        <div class="trash-meta">Eliminado: ${new Date(n._fechaEliminado).toLocaleString("es-ES")} Â· ID: ${n._id}</div>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-sm btn-green" onclick="restaurarNegocio('${k}')">â†©ï¸</button>
        <button class="btn btn-sm btn-red" onclick="eliminarDefNeg('${k}')">ğŸ’€</button>
      </div></div>`).join("");
  document.getElementById("papeleraCli").innerHTML=!cliItems.length
    ?'<div class="empty"><span>âœ…</span>Sin clientes eliminados</div>'
    :cliItems.map(([k,c])=>`<div class="trash-card">
      <div><div class="trash-name">ğŸ‘¤ ${c.nombre}</div>
        <div class="trash-meta">Eliminado: ${new Date(c._fechaEliminado).toLocaleString("es-ES")}</div>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-sm btn-green" onclick="restaurarCliente('${k}')">â†©ï¸</button>
        <button class="btn btn-sm btn-red" onclick="eliminarDefCli('${k}')">ğŸ’€</button>
      </div></div>`).join("");
};
window.restaurarNegocio=(key)=>{
  const n={...papeleraData.negocios[key]};const id=n._id;delete n._id;delete n._fechaEliminado;
  set(ref(db,"negocios/"+id),n).then(()=>{remove(ref(db,"papelera/negocios/"+key)).then(()=>{showPopup("â†©ï¸ Negocio restaurado!");logAccion(`Negocio restaurado: ${n.nombre}`,"negocio",id,null);});});
};
window.restaurarCliente=(key)=>{
  const c={...papeleraData.clientes[key]};const id=c._id;delete c._id;delete c._fechaEliminado;
  set(ref(db,"clientes/"+id),c).then(()=>{remove(ref(db,"papelera/clientes/"+key)).then(()=>{showPopup("â†©ï¸ Cliente restaurado!");logAccion(`Cliente restaurado: ${c.nombre}`,"cliente",null,id);});});
};
window.eliminarDefNeg=(key)=>{if(!confirm("Â¿Eliminar definitivamente?"))return;remove(ref(db,"papelera/negocios/"+key)).then(()=>showPopup("ğŸ’€ Eliminado"));};
window.eliminarDefCli=(key)=>{if(!confirm("Â¿Eliminar definitivamente?"))return;remove(ref(db,"papelera/clientes/"+key)).then(()=>showPopup("ğŸ’€ Eliminado"));};
window.vaciarPapelera=()=>{if(!confirm("Â¿Vaciar toda la papelera?"))return;remove(ref(db,"papelera/")).then(()=>showPopup("ğŸ—‘ï¸ Papelera vaciada"));};

// LOGS
function logAccion(mensaje,tipo="general",negocioId=null,clienteId=null){
  push(ref(db,"logs/"),{mensaje,tipo,negocioId,clienteId,timestamp:Date.now()});
}
window.logAccion=logAccion;
window.renderLogs=function(){
  const fT=document.getElementById("logFiltroTipo").value;
  const fN=document.getElementById("logFiltroNegocio").value;
  const fC=document.getElementById("logFiltroCliente").value;
  const busq=document.getElementById("logBusqueda").value.toLowerCase();
  const logs=Object.values(logsData).filter(l=>{
    if(fT&&l.tipo!==fT)return false;if(fN&&l.negocioId!==fN)return false;
    if(fC&&l.clienteId!==fC)return false;if(busq&&!l.mensaje.toLowerCase().includes(busq))return false;
    return true;
  }).sort((a,b)=>b.timestamp-a.timestamp);
  const pageLogs=logs.slice(logPage*LOGS_PER_PAGE,(logPage+1)*LOGS_PER_PAGE);
  const cont=document.getElementById("logsContainer");
  const icons={negocio:"ğŸ¢",cliente:"ğŸ‘¤",transaccion:"ğŸ’±",anuncio:"ğŸ“¢",general:"âš™ï¸"};
  if(!pageLogs.length){cont.innerHTML='<div class="empty"><span>ğŸ“‹</span>Sin logs</div>';document.getElementById("logsPaginacion").innerHTML="";return;}
  cont.innerHTML=pageLogs.map(l=>`<div class="log-entry">
    <span class="log-time">${new Date(l.timestamp).toLocaleString("es-ES")}</span>
    <span class="log-type">${icons[l.tipo]||"âš™ï¸"}</span>
    <span class="log-msg">${l.mensaje}</span>
  </div>`).join("");
  const totalPages=Math.ceil(logs.length/LOGS_PER_PAGE);
  let pg="";
  if(logPage>0)pg+=`<button class="btn btn-sm btn-ghost" onclick="cambiarPagLog(-1)">â† Ant.</button>`;
  pg+=`<span style="color:var(--muted);font-size:.82rem;">PÃ¡g. ${logPage+1}/${totalPages} (${logs.length})</span>`;
  if(logPage<totalPages-1)pg+=`<button class="btn btn-sm btn-ghost" onclick="cambiarPagLog(1)">Sig. â†’</button>`;
  document.getElementById("logsPaginacion").innerHTML=pg;
};
window.cambiarPagLog=(dir)=>{logPage=Math.max(0,logPage+dir);renderLogs();};
window.limpiarLogs=()=>{if(!confirm("Â¿Eliminar TODOS los logs?"))return;remove(ref(db,"logs/")).then(()=>showPopup("ğŸ—‘ï¸ Logs eliminados"));};

// TOGGLE & TABS
window.toggleCard=(id)=>{const c=document.getElementById(id);if(c)c.classList.toggle("expanded");};
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});
</script>
</body>
</html>
